## ä¸€ã€è¿›ç¨‹ä¸çº¿ç¨‹

- è¿›ç¨‹ï¼šä¸€ä¸ªç¨‹åºå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼›è¿›ç¨‹æ˜¯èµ„æºï¼ˆå†…å­˜ã€CPUã€ç¡¬ç›˜ï¼‰åˆ†é…çš„åŸºæœ¬å•ä½ï¼Œç”±æ“ä½œç³»ç»Ÿå®Œæˆåˆ†é…ï¼›

- çº¿ç¨‹ï¼šæ˜¯çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘åŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼›çº¿ç¨‹æ˜¯ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼›çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­ä¼šå…±ç”¨è¿›ç¨‹èµ„æºã€‚

  **ä¸ºäº†æé«˜ç³»ç»Ÿçš„æ‰§è¡Œæ•ˆç‡ï¼Œå‡å°‘å¤„ç†æœºçš„ç©ºè½¬æ—¶é—´å’Œè°ƒåº¦åˆ‡æ¢çš„æ—¶é—´ï¼Œä»¥åŠä¾¿äºç³»ç»Ÿç®¡ç†ï¼Œæ‰€ä»¥æœ‰äº†çº¿ç¨‹ï¼Œçº¿ç¨‹å–ä»£äº†è¿›ç¨‹è°ƒåº¦çš„åŸºæœ¬åŠŸèƒ½**

  ![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt09patgtj60qq09cq3v02.jpg)

- å¹¶å‘ï¼šè¯·æ±‚åŒæ—¶å‘ç”Ÿï¼ˆåŒä¸€æ—¶é—´é—´éš”å†…ï¼‰ï¼›

- å¹¶è¡Œå’Œä¸²è¡Œï¼šå¹¶è¡Œè¡¨ç¤ºåŒæ—¶è¿›è¡Œå¤„ç†ä»»åŠ¡ï¼ˆå¤šæ ¸CPUï¼ŒåŒä¸€æ—¶åˆ»ï¼‰ï¼›ä¸²è¡Œæ˜¯ä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªå¤„ç†ï¼›

- åŒæ­¥å’Œå¼‚æ­¥ï¼šåŒæ­¥æŒ‡çš„æ˜¯ä¸€ä¸ªä»»åŠ¡çš„å¼€å§‹å¿…é¡»ç­‰ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸï¼ˆæ¥åŠ›èµ›ï¼‰ï¼›å¼‚æ­¥æŒ‡çš„æ˜¯ä¸€ä¸ªä»»åŠ¡çš„å¼€å§‹æ— éœ€ç­‰å¾…å…¶ä»–ä»»åŠ¡ï¼›

- **é˜Ÿåˆ—åˆ†ä¸ºä¸²è¡Œå’Œå¹¶è¡Œ**

  **ä»»åŠ¡çš„æ‰§è¡Œåˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥**

- **é˜Ÿåˆ—åªæ˜¯è´Ÿè´£ä»»åŠ¡çš„è°ƒåº¦ï¼Œâ½½ä¸è´Ÿè´£ä»»åŠ¡çš„æ‰§è¡Œ**

  **ä»»åŠ¡æ˜¯åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œçš„**

  é˜Ÿåˆ—å’Œä»»åŠ¡çš„ç‰¹ç‚¹ï¼š

  é˜Ÿåˆ—çš„ç‰¹ç‚¹ï¼šå…ˆè¿›å…ˆå‡ºï¼Œæ’åœ¨å‰é¢çš„ä»»åŠ¡æœ€å…ˆæ‰§è¡Œï¼›


- ä¸²è¡Œé˜Ÿåˆ—ï¼šä»»åŠ¡æŒ‰ç…§é¡ºåºè¢«è°ƒåº¦ï¼Œå‰â¼€ä¸ªä»»åŠ¡ä¸æ‰§è¡Œå®Œæ¯•ï¼Œé˜Ÿåˆ—ä¸ä¼šè°ƒåº¦

- å¹¶è¡Œé˜Ÿåˆ—ï¼šåªè¦æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼Œé˜Ÿåˆ—å°±ä¼šè°ƒåº¦å½“å‰ä»»åŠ¡ï¼Œäº¤ç»™çº¿ç¨‹å»æ‰§è¡Œï¼Œä¸éœ€è¦è€ƒè™‘å‰â¾¯æ˜¯éƒ½æœ‰ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œåªè¦æœ‰çº¿ç¨‹å¯ä»¥åˆ©ç”¨ï¼Œé˜Ÿåˆ—å°±ä¼šè°ƒåº¦ä»»åŠ¡ã€‚

- **åŒæ­¥æ‰§è¡Œï¼š**ä¸ä¼šå¼€å¯æ–°çš„çº¿ç¨‹ï¼Œä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ

  **å¼‚æ­¥æ‰§è¡Œï¼š**ä¼šå¼€å¯æ–°çš„çº¿ç¨‹ï¼Œä»»åŠ¡å¯ä»¥å¹¶å‘çš„æ‰§è¡Œ

å¤šçº¿ç¨‹æ˜¯ä¸ºäº†æœ€å¤§åŒ–åˆ©ç”¨CPU

**çº¿ç¨‹çš„çŠ¶æ€ï¼š**

**NEW  -  RUNNABLE  -  BLOCKED  -  WAITING  -  TIMED_WAITING  -  TERMINATED;**

```java
    public enum State {
        /**
         * Thread state for a thread which has not yet started.
         */
        NEW,

        /**
         * Thread state for a runnable thread.  A thread in the runnable
         * state is executing in the Java virtual machine but it may
         * be waiting for other resources from the operating system
         * such as processor.
         */
        RUNNABLE,

        /**
         * Thread state for a thread blocked waiting for a monitor lock.
         * A thread in the blocked state is waiting for a monitor lock
         * to enter a synchronized block/method or
         * reenter a synchronized block/method after calling
         * {@link Object#wait() Object.wait}.
         */
        BLOCKED,

        /**
         * Thread state for a waiting thread.
         * A thread is in the waiting state due to calling one of the
         * following methods:
         * <ul>
         *   <li>{@link Object#wait() Object.wait} with no timeout</li>
         *   <li>{@link #join() Thread.join} with no timeout</li>
         *   <li>{@link LockSupport#park() LockSupport.park}</li>
         * </ul>
         *
         * <p>A thread in the waiting state is waiting for another thread to
         * perform a particular action.
         *
         * For example, a thread that has called {@code Object.wait()}
         * on an object is waiting for another thread to call
         * {@code Object.notify()} or {@code Object.notifyAll()} on
         * that object. A thread that has called {@code Thread.join()}
         * is waiting for a specified thread to terminate.
         */
        WAITING,

        /**
         * Thread state for a waiting thread with a specified waiting time.
         * A thread is in the timed waiting state due to calling one of
         * the following methods with a specified positive waiting time:
         * <ul>
         *   <li>{@link #sleep Thread.sleep}</li>
         *   <li>{@link Object#wait(long) Object.wait} with timeout</li>
         *   <li>{@link #join(long) Thread.join} with timeout</li>
         *   <li>{@link LockSupport#parkNanos LockSupport.parkNanos}</li>
         *   <li>{@link LockSupport#parkUntil LockSupport.parkUntil}</li>
         * </ul>
         */
        TIMED_WAITING,//é™æ—¶ç­‰å¾…

        /**
         * Thread state for a terminated thread.
         * The thread has completed execution.
         */
        TERMINATED;
    }
```



## äºŒã€çº¿ç¨‹çš„åˆ›å»º

**åˆ›å»ºçº¿ç¨‹æ–¹å¼1ï¼šè‡ªå®šä¹‰ä¸€ä¸ªç±»åŒºç»§æ‰¿Thread é‡å†™runæ–¹æ³•**

æ­¤æ–¹å¼åŸºæœ¬ä¸ç”¨ï¼Œextendåªèƒ½ç»§æ‰¿ä¸€ä¸ªï¼Œæ‰€ä»¥**ä¸€èˆ¬èƒ½ç”¨å®ç°æ¥å£çš„æ–¹æ³•å°±ä¸ç”¨ç»§æ‰¿ï¼**

```java
//å…ˆåˆ›å»ºä¸€ä¸ªå…¬å…±çº¿ç¨‹ç±»
package Thread;

import java.util.ArrayList;
/*
	æ–¹å¼1ï¼šè‡ªå®šä¹‰ä¸€ä¸ªç±»åŒºç»§æ‰¿Thread é‡å†™runæ–¹æ³•
*/

public class CustomThread extends Thread{
    @Override
    public void run() {
        for (int i = 0; i < 20; i++) {//å¿«æ·forï¼š20.for
            System.out.println("æ‰§è¡Œä»»åŠ¡" + i);
        }
    }
}
```

``` java
package Thread;

public class ThreadTest {
    public static void main(String[] args) {
        System.out.println("main start");
        //1ã€å…ˆåˆ›å»ºçº¿ç¨‹å¯¹è±¡
        CustomThread customThread = new CustomThread();
        //2ã€è°ƒç”¨start()æ–¹æ³•å‘Šè¯‰æ“ä½œç³»ç»Ÿçº¿ç¨‹å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥è¿›è¡Œè°ƒåº¦
        customThread.start();//è™½ç„¶å¯åŠ¨äº† ä½†æ²¡æœ‰ç«‹é©¬è¿›è¡Œè°ƒç”¨
        System.out.println("main end");
        /*
        è¾“å‡ºï¼š
        main start
        main end
        æ‰§è¡Œä»»åŠ¡0
        æ‰§è¡Œä»»åŠ¡1
        â€¦â€¦
         */
        // å› ä¸ºä¸»çº¿ç¨‹ä¸åˆ›å»ºçš„çº¿ç¨‹æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œæ‰€ä»¥main endå¹¶ä¸æ˜¯åœ¨customThread.start()ä¹‹åæ‰è¿è¡Œ
    }
}

```



**åˆ›å»ºçº¿ç¨‹æ–¹å¼2ï¼šå®ç°Runnableæ¥å£**ï¼šï¼ˆé€‚ç”¨äºå¯¹**çº¿ç¨‹æ— è¿”å›å€¼**è¦æ±‚çš„åœºæ™¯ï¼‰

1. ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç°ï¼›**æ³¨æ„ï¼šåŒ¿åå†…éƒ¨ç±»ä¸­å¯ä»¥æ˜¯æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼›**
2. ä½¿ç”¨lambdaè¡¨è¾¾å¼å®ç°ã€‚**æ³¨æ„ï¼šlambdaè¡¨è¾¾å¼:åªèƒ½æ˜¯æ¥å£ï¼Œä¸”æ¥å£ä¸­åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæ‰å¯ä»¥ä½¿ç”¨ã€‚**

```java
    public static void main(String[] args) {
        //åŒ¿åå†…éƒ¨ç±»å½¢å¼
        Thread threadA = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 100; i++) {
                    System.out.println("threadA" + i);
                }
            }
        });
        //lambdaè¡¨è¾¾å¼å½¢å¼
        Thread threadB = new Thread(() ->{
            for (int i = 0; i < 100; i++) {
                System.out.println("threadB" + i);
            }
        });
        threadA.start();
        threadB.start();
        // ä¸¤ä¸ªçº¿ç¨‹çš„è°ƒåº¦æ˜¯ç”±æ“ä½œç³»ç»Ÿå®Œæˆçš„ï¼Œæ¯æ¬¡è¿è¡Œçš„ç»“æœéƒ½ä¼šä¸ä¸€æ ·
    }
```

**åˆ›å»ºçº¿ç¨‹æ–¹å¼3ï¼šå€ŸåŠ©ä¸­é—´ç±»FutureTaskå®ç°Callableæ¥å£**ï¼ˆçº¿ç¨‹æ‰§è¡Œå®Œ**æœ‰è¿”å›å€¼**ï¼‰

1. ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç°ï¼›
2. ä½¿ç”¨lambdaè¡¨è¾¾å¼å®ç°ï¼›
3. futureTask.get()è·å–çº¿ç¨‹çš„è¿”å›ç»“æœã€‚

```java
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        FutureTask<Integer> futureTask = new FutureTask<>(new Callable<Integer>() {//åŒ¿åå†…éƒ¨ç±»
            @Override
            public Integer call() throws Exception {
                int sum = 0;
                for (int i = 0; i < 20; i++) {
                    sum += i;
                }
                return sum;
            }
        });
        Thread thread = new Thread(futureTask);
        thread.start();
        Integer integer = futureTask.get();//getæ˜¯ä¸€ä¸ªé˜»å¡å¼æ–¹æ³•ï¼Œéœ€è¦ç­‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œæ‰ä¼šæœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥è°ƒç”¨getä¹‹å‰ï¼Œä¸€å®šè¦å¯åŠ¨çº¿ç¨‹ã€‚
        System.out.println(integer);
    }
```

**åˆ›å»ºçº¿ç¨‹æ–¹å¼4ï¼šä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œåˆ›å»º**

```java
```





## ä¸‰ã€çº¿ç¨‹çš„å¸¸ç”¨æ–¹æ³•

1. threadA.getState()ï¼šè·å–çº¿ç¨‹çš„çŠ¶æ€ï¼›
2. threadA.getId()ã€getName()ï¼šè·å–OSéšæœºåˆ†é…çš„çº¿ç¨‹IDå’Œåå­—ï¼›
3. threadA.getPriority():è·å–çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼›
4. Thread.sleep(2000L)ï¼šè®©å½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼›ä½†æ­¤æ–¹æ³•åœ¨ä¼‘çœ æ—¶é—´é•¿æ—¶ä¸é€‚ç”¨ï¼›
5. TimeUnit.SECONDS.sleep(10)ï¼šæ­¤æ—¶çš„æ—¶é—´å•ä½å¯ä»¥è‡ªå·±è®¾å®šï¼Œæ›´æ–¹ä¾¿ä½¿ç”¨ï¼›
6. Thread.currentThread()ï¼šè·å–å½“å‰çº¿ç¨‹ï¼›
7. Thread.activeCount()ï¼šç»Ÿè®¡å½“å‰æ¿€æ´»çš„çº¿ç¨‹ï¼›æ³¨æ„åå°ä¸€ç›´æœ‰ä¸€ä¸ªgcçº¿ç¨‹ï¼›
8. threadA.join():mainçº¿ç¨‹å¿…é¡»ç­‰å¾…threadAæ‰§è¡Œå®Œäº†æ‰æ‰§è¡Œï¼›

```java
public static void main(String[] args) {
    Thread threadA = new Thread(new Runnable() {
        @Override
        public void run() {
            for (int i = 0; i < 20; i++) {
                //System.out.println("æ‰§è¡Œä»»åŠ¡" + i);
            }
            try {
                TimeUnit.SECONDS.sleep(10);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            /*try {
                Thread.sleep(2000L);//å†™åœ¨çº¿ç¨‹Aé‡Œé¢çš„ï¼Œæ‰€ä»¥æ˜¯è®©çº¿ç¨‹Aä¼‘çœ 
            } catch (InterruptedException e) {
                e.printStackTrace();
            }*/
            System.out.println("threadA end");
        }
    },"ThreadA");//å¯ä»¥è‡ªå·±æŒ‡å®šçº¿ç¨‹åå­—
    threadA.start();
    //threadA.getState()ï¼šè·å–çº¿ç¨‹çš„çŠ¶æ€
    System.out.println(threadA.getState());//RUNNABLE
    //threadA.getId()ã€getName()ï¼šè·å–OSéšæœºåˆ†é…çš„çº¿ç¨‹IDå’Œåå­—
    System.out.println("id-" + threadA.getId());//id-15
    System.out.println("name-" + threadA.getName());//name-Thread-0

    //getPriority()çº¿ç¨‹ä¼˜å…ˆçº§
    //10è¡¨ç¤ºæœ€å¤§ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬çº¿ç¨‹ä¼˜å…ˆçº§éƒ½æ˜¯5ï¼›ä½†è®¾å®šä¼˜å…ˆçº§å¹¶ä¸ä»£è¡¨OSä¸€å®šä¼˜å…ˆæ‰§è¡Œï¼Œåªæ˜¯OSå…ˆæ‰§è¡Œçš„å¯èƒ½æ€§æ›´å¤§
    System.out.println("Priority-" + threadA.getPriority());

    //Thread.sleep(2000L)è®©å½“å‰çº¿ç¨‹ç¡çœ /ms
    try {
        Thread.sleep(2000L);//è¿™é‡Œæ˜¯è®©ä¸»çº¿ç¨‹ä¼‘çœ 
    } catch (InterruptedException e) {
        e.printStackTrace();
    }

    //è·å–å½“å‰çº¿ç¨‹
    Thread thread = Thread.currentThread();
    System.out.println("main end");
}
```

```java
    public static void main(String[] args) {
        Thread thread = new Thread(() -> {
            for (int i = 0; i < 20; i++) {
                System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œä»»åŠ¡" + i);
            }
        },"ThreadA");
        thread.start();
        try {
            thread.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(Thread.activeCount());//count:2,ä¸æ­¢æœ‰mainçº¿ç¨‹ï¼Œè¿˜æœ‰gcçº¿ç¨‹
    }
```





## å››ã€çº¿ç¨‹å®‰å…¨ï¼ˆsynchronized-reentrantLockï¼‰

- JMM (Java memory model) Javaå†…å­˜æ¨¡å‹ã€‚JMMæ˜¯â€”å¥—è§„åˆ™è§„èŒƒ
- JMMè§„èŒƒä¸­æŒ‡å®šJavaçš„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œç©ºé—´(å·¥ä½œå†…å­˜)ï¼Œçº¿ç¨‹çš„å·¥ä½œå†…å­˜æ˜¯äº’ä¸å¹²æ‰°çš„ï¼Œæ˜¯ç›¸äº’ç‹¬ç«‹çš„;çº¿ç¨‹å†…éƒ¨çš„æ–¹æ³•ä¸­å‡ºç°çš„å±€éƒ¨å˜é‡éƒ½åœ¨å·¥ä½œå†…å­˜ä¸­;ä½†çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å…±äº«ä¸»å­˜(å…±äº«å†…å­˜â€”â€”å †ç©ºé—´å’Œæ–¹æ³•åŒºï¼‰çš„ç©ºé—´;
- å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«å†…å­˜çš„æ•°æ®æ—¶æ‰ä¼šæ¶‰åŠåˆ°æ•°æ®å®‰å…¨é—®é¢˜;

### **1ã€å¤šçº¿ç¨‹ä¸å®‰å…¨ä¾‹å­ï¼š**

```java
package Thread;
//æ–°å»ºä¸€ä¸ªé“¶è¡Œç±»
public class BankAccount {
    private  double balance;

    public double getBalance() {
        return balance;
    }

    public synchronized void saveMoney(double money){
        //1ï¼Œå…ˆå–å‡ºbalanceçš„å€¼ï¼ˆä»ä¸»å­˜ä¸­å–å‡ºåˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼‰
        //2ï¼Œç´¯åŠ 
        //3ï¼Œç»™balanceé‡æ–°èµ‹å€¼
        
        //è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™ä¸‰æ­¥å¿…é¡»ä¿è¯åŸå­æ€§ï¼åªéœ€è¦åŠ å…¥å…³é”®å­—ï¼šsynchronized
        
        balance += money;
    }

    public synchronized void withdrawMoney(double money){
        balance -= money;
    }

}

```

```java
package Thread;

public class ThreadSecurity {
    public static void main(String[] args) {
        BankAccount bankAccount = new BankAccount();
        Thread threadA = new Thread(() ->{
            for (int i = 0; i < 20000; i++) {
                bankAccount.saveMoney(100);
            }
            System.out.println("ThreadA end");
        });
        
        Thread threadB = new Thread(() ->{
            for (int i = 0; i < 20000; i++) {
                bankAccount.withdrawMoney(100);
            }
            System.out.println("ThreadB end");
        });

        threadA.start();
        threadB.start();
        System.out.println("ä½™é¢ï¼š" + bankAccount.getBalance());//ç”±äºä¸»çº¿ç¨‹å’Œçº¿ç¨‹Aã€çº¿ç¨‹Bå¹¶ä¸èƒ½åŒæ—¶ç»“æŸï¼Œæ‰€ä»¥æ‰“å°ç»“æœå¯èƒ½ä¸æ˜¯é›¶ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹å¯¼è‡´çš„é—®é¢˜ã€‚
    }
}
```

**åŸå­æ€§ï¼šå¤šä¸ªæ“ä½œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼Œæ–¹æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¢«æ‰“æ–­ï¼**

### 2ã€å…³é”®å­—ï¼šsynchronized

ğŸ“•ï¼ˆ`synchronized`ç»è¿‡javacç¼–è¯‘åä¼šç”Ÿæˆ`monitorenter`å’Œ`monitorexit`ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤->è€Œmonitoræ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿçš„mutex lockæ¥å®ç°çš„ï¼Œæ‰€ä»¥æ¯å½“æŒ‚èµ·å’Œå”¤é†’ä¸€ä¸ªçº¿ç¨‹éƒ½è¦åˆ‡æ¢å†…æ ¸æ€ï¼Œå› æ­¤ä¼šå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥1.6ä¹‹åå¼•å…¥äº†**åå‘é”å’Œè½»é‡çº§é”**ï¼‰

- synchronizedæ˜¯ä¸€ç§**äº’æ–¥é”**ï¼Œä¸€æ¬¡åªèƒ½å…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è¢«é”ä½çš„ä»£ç å—
- synchronizedæ˜¯Javaçš„ä¸€ä¸ªå…³é”®å­—ï¼Œå®ƒèƒ½å¤Ÿå°†**ä»£ç å—/æ–¹æ³•**é”èµ·æ¥
- å¦‚æœsynchronizedä¿®é¥°çš„æ˜¯å®ä¾‹æ–¹æ³•ï¼Œå¯¹åº”çš„é”åˆ™æ˜¯å¯¹è±¡å®ä¾‹
- å¦‚æœsynchronizedä¿®é¥°çš„æ˜¯é™æ€æ–¹æ³•ï¼Œå¯¹åº”çš„é”åˆ™æ˜¯å½“å‰ç±»çš„Classå®ä¾‹
- å¦‚æœsynchronizedä¿®é¥°çš„æ˜¯ä»£ç å—ï¼Œå¯¹åº”çš„é”åˆ™æ˜¯ä¼ å…¥synchronizedçš„å¯¹è±¡å®ä¾‹

![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt0naqy9fj61ge0bsgo802.jpg)

ğŸ§å…³äºsynchronizedé”åœ¨JDK 1.6ä¹‹ååšçš„ä¼˜åŒ–ï¼š

- åœ¨JDK 1.6ä¹‹å‰æ˜¯é‡é‡çº§é”ï¼šåŠ é”æ˜¯ä¾èµ–åº•å±‚æ“ä½œç³»ç»Ÿçš„`mutex`ç›¸å…³æŒ‡ä»¤å®ç°ï¼Œæ‰€ä»¥ä¼šæœ‰**ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„åˆ‡æ¢**ï¼Œæ€§èƒ½æŸè€—ååˆ†æ˜æ˜¾
- è€ŒJDK1.6 ä»¥å**å¼•å…¥åå‘é”å’Œè½»é‡çº§**é”**åœ¨JVMå±‚é¢å®ç°åŠ é”çš„é€»è¾‘ï¼Œä¸ä¾èµ–åº•å±‚æ“ä½œç³»ç»Ÿ**ï¼Œå°±æ²¡æœ‰åˆ‡æ¢çš„æ¶ˆè€—ï¼›

Mark Wordå¯¹é”çš„çŠ¶æ€è®°å½•ä¸€å…±æœ‰4ç§ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”ï¼ˆè‡ªæ—‹ï¼‰å’Œé‡é‡çº§é”ï¼š

![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt0qwr7gyj61bs064q4b02.jpg)

PSï¼šè‡ªæ—‹â‰ˆCPUç©ºè½¬ï¼Œ->æ”¹è¿›åå‡ºç°äº†â€œé€‚åº”æ€§è‡ªæ—‹â€ï¼Œè‡ªæ—‹æ—¶é—´ä¸å›ºå®šï¼›

**1ã€å…³é”®å­—ï¼šsynchronizedï¼šåŠ åœ¨æ–¹æ³•å£°æ˜å¤„ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æƒ³è¦å»æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œå¿…é¡»å…ˆè·å¾—å½“å‰å¯¹è±¡çš„å¯¹è±¡é”**->çº¿ç¨‹åŒæ­¥

å †ä¸­å­˜æ”¾çš„å¯¹è±¡é™¤äº†æœ‰å¯¹è±¡çš„æˆå‘˜å˜é‡ä»¥å¤–ï¼Œ**æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡é”ï¼Œä¸”ä»…æœ‰ä¸€ä¸ªï¼›**

å½“æ–¹æ³•åŠ å…¥synchronizedå…³é”®å­—åï¼Œå½“å‰çº¿ç¨‹æƒ³è¦æ‰§è¡Œå¯¹è±¡çš„æ–¹æ³•ï¼Œéœ€å…ˆè·å¾—å¯¹è±¡é”ï¼

æ‰€ä»¥ä¸Šè¿°ä¾‹å­åœ¨åŠ å…¥synchronizedå…³é”®å­—åï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºçº¿ç¨‹Aè°ƒç”¨bankAccountå¯¹è±¡çš„saveMoneyæ–¹æ³•çš„æ—¶å€™ï¼Œå…ˆè·å–äº†bankAccountå¯¹è±¡çš„å¯¹è±¡é”ï¼Œæ‰€ä»¥çº¿ç¨‹Bæƒ³è¦è°ƒç”¨withdrawMoneyæ–¹æ³•æ—¶æ— æ³•è·å¾—bankAccountå¯¹è±¡é”ï¼

**2ã€å…³é”®å­—ï¼šsynchronizedä¹Ÿå¯ä»¥åŠ åœ¨æ–¹æ³•ä½“å†…éƒ¨ï¼Œè¡¨ç¤ºåŒæ­¥ä»£ç å—èŒƒå›´ç¼©å°äº†**

```java
package Thread;
//æ–°å»ºä¸€ä¸ªé“¶è¡Œç±»
public class BankAccount2 {
    private  double balance;
    
public double getBalance() {
    return balance;
}

public void saveMoney(double money){

    synchronizedï¼ˆthisï¼‰{//è¿™æ ·é”çš„èŒƒå›´å¯ä»¥æ›´å…·ä½“ï¼
        balance += money;
    }
    
}

public synchronized void withdrawMoney(double money){
    balance -= money;
	}
}
```

**3ã€synchronizedæ³¨æ„ç‚¹ï¼š**

- synchronizedç§°ä¸ºå†…ç½®é”ï¼ˆéšç€jdkå‡ºç”Ÿçš„ï¼‰ã€å¯é‡å…¥é”ï¼ˆæ— éœ€é‡å¤è·å–é”ï¼‰ã€æ’ä»–é”ï¼ˆäº’æ–¥é”ï¼‰ã€éå…¬å¹³é”

```java
package Thread;
//æ–°å»ºä¸€ä¸ªé“¶è¡Œç±»
public class BankAccount3 {
    private  double balance;
    
public double getBalance() {
    return balance;
}

public synchronized void saveMoney(double money){

    balance += money;
    withdrawMoney(money);//æ­¤å¤„è°ƒç”¨çš„ç¬¬äºŒä¸ªæ–¹æ³•ä¹Ÿå¸¦é”ï¼Œä½†æ— éœ€é‡å¤è·å–å¯¹è±¡é”ï¼->å¯é‡å…¥é”
}

public synchronized void withdrawMoney(double money){
    balance -= money;
	}
}
```

- synchronizedå¦‚æœç”¨åœ¨é™æ€æ–¹æ³•ä¸Šé¢ï¼Œè¡¨ç¤ºéœ€è¦è·å–ç±»å¯¹è±¡çš„å¯¹è±¡é”ï¼›

  è·å–ç±»å¯¹è±¡æœ‰ä¸‰ç§æ–¹å¼

```java
public synchronized static void method3(){

}
```

- synchronizedåŒæ­¥æ–¹æ³•ï¼ˆåŒæ­¥ä»£ç å—ï¼‰åœ¨è¿›è¡Œæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¼‚å¸¸äº§ç”Ÿï¼Œå¯ä»¥æ­£å¸¸é‡Šæ”¾å¯¹è±¡é”ï¼›

- sleep()æ–¹æ³•ä¸ä¼šé‡Šæ”¾é”ï¼Œçº¿ç¨‹ä¼šæŠ±ç€é”ç¡ï¼›

- å¦‚æœä¸€ä¸ªç±»å†…éƒ¨æ²¡æœ‰è€ƒè™‘åŒæ­¥ï¼Œå¤–éƒ¨ä½¿ç”¨çš„æ—¶å€™ä¹Ÿå¯ä»¥åŠ åŒæ­¥åšåˆ°æ•°æ®å®‰å…¨ï¼

  å¦‚æœä¸€ä¸ªç±»å†…éƒ¨ä½¿ç”¨äº†æ–¹æ³•åŒæ­¥ï¼Œå¤–éƒ¨åœ¨ä½¿ç”¨æ—¶ä¸éœ€è¦è€ƒè™‘æ–¹æ³•åŒæ­¥ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ã€‚

  ```java
          Thread threadA = new Thread(() ->{
              synchronized(bankAccount){
                  for (int i = 0; i < 20000; i++) {
                  	bankAccount.saveMoney(100);
              	}	
              }
              System.out.println("ThreadA end");
          });
  ```

### 3ã€æ˜¾ç¤ºé”ReentrantLockï¼ˆæ˜¯ä¸€ä¸ªç±»ï¼Œçº¯javaå†™çš„ï¼Œå€ŸåŠ©AQSï¼‰ï¼šè¯¦ç»†çš„ç¬”è®°åœ¨AQSä¸­

- **ReentrantLock reentrantLock = new ReentrantLock();**
- **ä¸Šé”å’Œé‡Šæ”¾é”ç”±ç¨‹åºå‘˜æ§åˆ¶ï¼›**
- **å‡ºç°å¼‚å¸¸åæ˜¾ç¤ºé”æ˜¯ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾çš„ï¼Œé‡Šæ”¾é”çš„ä»£ç å¯ä»¥æ”¾åœ¨finallyä¸­ï¼Œä»¥æ­¤é¿å…é—®é¢˜ï¼›**
- **æ˜¾ç¤ºé”ï¼šå¯é‡å…¥é”ã€äº’æ–¥é”**
- **ReentrantLocké»˜è®¤æ˜¯æŠŠéå…¬å¹³é”ï¼›ReentrantLock reentrantLock = new ReentrantLock(true),å¯ä¼ å‚å®šä¹‰æ˜¯å¦ä¸ºå…¬å¹³é”ï¼ˆå…ˆåˆ°å…ˆå¾—ï¼‰;æ€§èƒ½è€Œè¨€ï¼šéå…¬å¹³é”æ›´é«˜**

```java
public class BankAccount {
    private  double balance;
    ReentrantLock reentrantLock = new ReentrantLock();
    public double getBalance() {
        return balance;
    }

    public void saveMoney(double money){
        reentrantLock.lock();//è·å–é”ï¼Œé˜»å¡å¼æ–¹æ³•
        balance += money;
        reentrantLock.unlock();
    }

    public void withdrawMoney(double money){
        reentrantLock.lock();//æ³¨æ„è¦ä¿è¯é”çš„å”¯ä¸€æ€§
        balance -= money;
        reentrantLock.unlock();
    }
}
```

- ä»¥ä¸‹æ“ä½œæ˜¯ä¸ºäº†é¿å…å‡ºç°å¼‚å¸¸æ—¶é”æ²¡æœ‰é‡Šæ”¾ï¼š

```java
public void saveMoney(double money){
    reentrantLock.lock();
    try{
        System.out.println(1 / 0);
        balance += money;
    }finally {
        reentrantLock.unlock();
    }

}
```

### 4ã€æ­»é”

é€ æˆæ­»é”çš„åŸå› å¯ä»¥ç®€å•æ¦‚æ‹¬ä¸ºï¼šå½“å‰çº¿ç¨‹æ‹¥æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦çš„èµ„æºï¼Œå½“å‰çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å·²æ‹¥æœ‰çš„èµ„æºï¼Œéƒ½ä¸æ”¾å¼ƒè‡ªå·±æ‹¥æœ‰çš„èµ„æºã€‚

- çº¿ç¨‹ä¹‹é—´å‡ºç°**ç›¸äº’ç­‰å¾…**ï¼Œç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼ˆæ¯”å¦‚åµŒå¥—ä½¿ç”¨synchronizedå…³é”®å­—å®¹æ˜“å¯¼è‡´æ­»é”ï¼‰

**è§£å†³æ­»é”æ€è·¯ï¼š**

1. å›ºå®šåŠ é”çš„é¡ºåºï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Hashå€¼çš„å¤§å°æ¥ç¡®å®šåŠ é”çš„å…ˆå
2. å°½å¯èƒ½ç¼©å‡åŠ é”çš„èŒƒå›´ï¼Œç­‰åˆ°æ“ä½œå…±äº«å˜é‡çš„æ—¶å€™æ‰åŠ é”ã€‚
3. ä½¿ç”¨å¯é‡Šæ”¾çš„å®šæ—¶é”-tryLockï¼ˆä¸€æ®µæ—¶é—´ç”³è¯·ä¸åˆ°é”çš„æƒé™äº†ï¼Œç›´æ¥é‡Šæ”¾æ‰ï¼‰

è§£å†³1ï¼š**reentrantLock.tryLock()**

- æ— å‚æ¨¡å¼ï¼šboolean reentrantLock.tryLock() è¡¨ç¤ºå°è¯•è·å–é”ï¼Œç«‹åˆ»è¿”å›ï¼Œå¦‚æœè·å–åˆ°é”ï¼Œè¿”å›true -> é¿å…é˜»å¡å‘ç”Ÿæ­»é”

```java
public boolean tryLock() {
    return sync.tryLock();
}
```

- å¸¦å‚æ¨¡å¼ï¼šreentrantLock.tryLock(5L, TimeUnit.SECONDS)ï¼Œç­‰å¾…timeoutæ—¶é—´ï¼Œæ‹¿ä¸åˆ°é”å†æ”¾å¼ƒï¼›

```java
public boolean tryLock(long timeout, TimeUnit unit)
        throws InterruptedException {
    return sync.tryLockNanos(unit.toNanos(timeout));
}
```

### 5ã€SynchronizedğŸ”’çš„ä¼˜åŒ–ï¼šåå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”

é“ºå«çŸ¥è¯†ğŸ“•ï¼š

<img src="D:\ç®—æ³•Typora\picture\9f6f835a847e40d9983365329470c640.png" alt="img" style="zoom: 25%;" />

- HotSpotè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼šå¯¹è±¡å¤´Headerã€å®ä¾‹æ•°æ®Instance Data å’Œå¯¹é½å¡«å……Padding;
- å¯¹è±¡å¤´åŒ…æ‹¬ä¸‰éƒ¨åˆ†ä¿¡æ¯ï¼šMarkWordã€æŒ‡å‘ç±»æŒ‡é’ˆã€æ•°ç»„é•¿åº¦

**MarkWord**ï¼šæ¯”å¦‚ hashç ï¼Œå¯¹è±¡æ‰€å±çš„å¹´ä»£ï¼Œå¯¹è±¡é”ï¼Œé”çŠ¶æ€æ ‡å¿—ï¼Œåå‘é”ï¼ˆçº¿ç¨‹ï¼‰IDï¼Œåå‘æ—¶é—´ï¼Œæ•°ç»„é•¿åº¦ï¼ˆæ•°ç»„å¯¹è±¡ï¼‰ç­‰

![image-20220717102149641](D:\ç®—æ³•Typora\picture\image-20220717102149641.png)



![image-20220716153306210](D:\ç®—æ³•Typora\picture\image-20220716153306210.png)

**åœ¨é”æ ‡å¿—ä½ï¼š0 0->è½»é‡çº§é”ï¼ˆè‡ªæ—‹é”ï¼‰ã€1 0->é‡é‡çº§é”ã€1 1->é”è¢«å›æ”¶ã€0 1->éœ€è¦å†åŠ ä¸€ä¸ªåå‘é”ä½ï¼š001->æ— é”|101->åå‘é”**

ğŸ§ ï¼šé©¬æ¡¶ç«äº‰ä¾‹å­ï¼

- **åå‘é”**ï¼ˆ**åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº**ï¼‰ï¼šJVMä¼šè®¤ä¸º**åªæœ‰æŸä¸ªçº¿ç¨‹æ‰ä¼šæ‰§è¡ŒåŒæ­¥ä»£ç **ï¼ˆæ²¡æœ‰ç«äº‰çš„ç¯å¢ƒï¼‰ğŸï¼šå› ä¸ºç»ç»Ÿè®¡ï¼Œå¤šæ•°çš„synchronizedæ–¹æ³•ï¼Œå†å¾ˆå¤šæƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼ˆä¾‹å¦‚StringBufferä¸­çš„appendã€Vectorä¸­çš„ä¸€äº›syncæ–¹æ³•ç­‰ï¼‰ã€‚

  åå‘é”æ­¥éª¤å¦‚ä¸‹ï¼š

  - MarkWordä¼šç›´æ¥è®°å½•çº¿ç¨‹IDï¼Œåªè¦çº¿ç¨‹æ¥æ‰§è¡Œä»£ç äº†ï¼Œä¼šæ¯”å¯¹çº¿ç¨‹IDæ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™å½“å‰çº¿ç¨‹èƒ½ç›´æ¥è·å–å¾—åˆ°é”ï¼Œæ‰§è¡ŒåŒæ­¥ä»£ç ï¼›
  - å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ç”¨CASæ¥å°è¯•ä¿®æ”¹å½“å‰çš„çº¿ç¨‹IDï¼Œå¦‚æœCASä¿®æ”¹æˆåŠŸï¼Œé‚£è¿˜æ˜¯èƒ½è·å–å¾—åˆ°é”ï¼Œæ‰§è¡ŒåŒæ­¥ä»£ç ï¼›
  - å¦‚æœCASå¤±è´¥äº†ï¼Œè¯´æ˜æœ‰ç«äº‰ç¯å¢ƒï¼Œæ­¤æ—¶ä¼šå¯¹åå‘é”æ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚

- è½»é‡çº§é”ï¼ˆ**å¤šä¸ªçº¿ç¨‹äº¤æ›¿è¿›å…¥ä¸´ç•ŒåŒº**ï¼‰ï¼š**ä¸ç»è¿‡åº•å±‚æ“ä½œç³»ç»Ÿ**ï¼Œè‡ªæ—‹ï¼ˆwhile)ï¼Œåœ¨è½»é‡çº§é”çš„çŠ¶æ€ä¸‹ï¼Œå½“å‰çº¿ç¨‹ä¼šåœ¨æ ˆå¸§ä¸‹åˆ›å»º`LockRecord`ï¼ŒLockRecordä¼šæŠŠMark Wordçš„ä¿¡æ¯æ‹·è´è¿›å»ï¼Œä¸”æœ‰ä¸ª**`Owner`æŒ‡é’ˆ**æŒ‡å‘åŠ é”çš„å¯¹è±¡ï¼çº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—æ—¶ï¼Œåˆ™ç”¨CASè¯•å›¾å°†Mark WordæŒ‡å‘çº¿ç¨‹æ ˆå¸§çš„Lock Recordï¼Œå‡è®¾**CASä¿®æ”¹æˆåŠŸï¼Œåˆ™è·å¾—è½»é‡çº§é”**ï¼è‹¥ä¿®æ”¹å¤±è´¥ï¼Œåˆ™è‡ªæ—‹ï¼Œ**è‡ªæ—‹ä¸€å®šæ¬¡æ•°åï¼Œåˆ™å‡çº§ä¸ºé‡é‡çº§é”ã€‚**

- é‡é‡çº§é”ï¼ˆå¤šçº¿ç¨‹**åŒæ—¶è¿›**å…¥ä¸´ç•ŒåŒºï¼‰

ğŸ§ **æ€»ç»“**ï¼š

- synchronizedé”åœ¨1.5ä¹‹å‰æ˜¯é‡é‡çº§é”ï¼Œä¾èµ–åº•å±‚æ“ä½œç³»ç»Ÿçš„mutexæŒ‡ä»¤å®ç°ï¼Œéœ€è¦ç”¨æˆ·æ€ä¸å†…æ ¸æ€åˆ‡æ¢ï¼Œæ€§èƒ½æŸè€—ååˆ†æ˜æ˜¾ï¼›
- **é‡é‡çº§é”ç”¨åˆ°monitorå¯¹è±¡ï¼Œè€Œåå‘é”åˆ™åœ¨Mark Wordè®°å½•çº¿ç¨‹IDè¿›è¡Œæ¯”å¯¹ï¼Œè½»é‡çº§é”åˆ™æ˜¯æ‹·è´Mark Wordåˆ°Lock Recordä¸­ï¼Œç”¨CASï¼‹è‡ªæ—‹çš„æ–¹å¼è·å–**
- ![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt125cqodj61p00c8wh502.jpg)
- 

ğŸ“•é¢è¯•é¢˜ï¼š

1. ä¸ºä»€ä¹ˆæœ‰è‡ªæ—‹é”è¿˜éœ€è¦é‡é‡çº§é”ï¼Ÿ
   - **è‡ªæ—‹æ˜¯æ¶ˆè€—CPUèµ„æºçš„**ï¼Œå¦‚æœé”çš„æ—¶é—´é•¿ï¼Œè·çŸ¥è‡ªæ—‹çº¿ç¨‹å¤šï¼ŒCPUä¼šè¢«å¤§é‡æ¶ˆè€—ï¼›
   - **é‡é‡çº§é”æœ‰ç­‰å¾…é˜Ÿåˆ—**ï¼Œæ‰€æœ‰æ‹¿ä¸åˆ°é”çš„çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸éœ€è¦æ¶ˆè€—CPUèµ„æºã€‚
2. åå‘é”æ˜¯å¦ä¸€å®šæ¯”è‡ªæ—‹é”æ•ˆç‡é«˜ï¼Ÿ
   - åœ¨æ˜ç¡®çŸ¥é“ä¼šæœ‰å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œåå‘é”ä¼šé¢‘ç¹æ¶‰åŠé”æ’¤é”€ï¼Œè¿™æ—¶å€™ç›´æ¥ä½¿ç”¨è‡ªæ—‹é”ï¼›
   - JVMåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰å¾ˆå¤šçº¿ç¨‹ç«äº‰ï¼Œå¦‚æœä½¿ç”¨åå‘é”ï¼Œå°±ä¼šé€ æˆåå‘é”ä¸æ–­åœ°è¿›è¡Œé”æ’¤é”€å’Œé”å‡çº§ï¼Œæ•ˆç‡è¾ƒä½ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µå¯åŠ¨æ—¶éœ€è¦ç­‰å¾…4sæ‰èƒ½æ‰“å¼€åå‘é”ã€‚`BiasedLockingStartUpDelay=0`->ç›´æ¥å¯åŠ¨åå‘é”ï¼Œåˆ™newå‡ºæ¥çš„å¯¹è±¡ï¼Œé»˜è®¤å°±æ˜¯ä¸€ä¸ª**å¯åå‘åŒ¿åå¯¹è±¡**`101`ã€‚

### 6ã€å…¬å¹³é”ä¸éå…¬å¹³é”

- å…¬å¹³é”ï¼šåœ¨ç«äº‰ç¯å¢ƒä¸‹ï¼Œå…ˆåˆ°ä¸´ç•ŒåŒºçš„çº¿ç¨‹æ¯”ååˆ°çš„çº¿ç¨‹ä¸€å®šæ›´å¿«åœ°è·å–å¾—åˆ°é”ï¼›
- éå…¬å¹³é”ï¼šå…ˆåˆ°ä¸´ç•ŒåŒºçš„çº¿ç¨‹æœªå¿…æ¯”ååˆ°çš„çº¿ç¨‹æ›´å¿«åœ°è·å–å¾—åˆ°é”ï¼›å¦‚`synchronized`é”å°±æ˜¯éå…¬å¹³çš„

1. å…¬å¹³é”çš„å®ç°ï¼š

   å…¬å¹³é”å¯ä»¥æŠŠç«äº‰çš„çº¿ç¨‹æ”¾åœ¨ä¸€ä¸ª**å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—**ä¸Šï¼Œåªè¦æŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œå”¤é†’é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹å»è·å–é”å°±å¥½äº†ï¼›

2. éå…¬å¹³é”çš„å®ç°ï¼š

   çº¿ç¨‹å…ˆå°è¯•èƒ½ä¸èƒ½è·å–å¾—åˆ°é”ï¼Œå¦‚æœè·å–å¾—åˆ°é”äº†å°±æ‰§è¡ŒåŒæ­¥ä»£ç äº†ï¼Œå¦‚æœè·å–ä¸åˆ°é”ï¼Œé‚£å°±å†æŠŠè¿™ä¸ªçº¿ç¨‹æ”¾åˆ°é˜Ÿåˆ—ï¼›


![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt55obq5tj60t409a0to02.jpg)









## äº”ã€çº¿ç¨‹å®‰å…¨çš„ç±»

### 1ã€é›†åˆä¸­çº¿ç¨‹å®‰å…¨çš„ç±»ï¼š

**æ‰€è°“çº¿ç¨‹å®‰å…¨å°±æ˜¯å¤šä¸ªçº¿ç¨‹å»æ‰§è¡ŒæŸç±»ï¼Œè¿™ä¸ªç±»å§‹ç»ˆèƒ½è¡¨ç°å‡ºæ­£ç¡®çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚**

ğŸ–ï¼š**æˆå‘˜å˜é‡**å®åœ¨å…±äº«ç©ºé—´ä¸­ï¼Œå¤šçº¿ç¨‹æ˜¯è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›è€Œ**å±€éƒ¨å˜é‡**æ˜¯åœ¨çº¿ç¨‹è‡ªå·±çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä¸éœ€è¦è€ƒè™‘å®‰å…¨é—®é¢˜ï¼

1ã€é›†åˆä¸­ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ï¼ˆä½†ä¹Ÿå¯ä»¥è¿›è¡Œå¤–éƒ¨åŠ é”çš„æ–¹å¼è¿›è¡ŒåŒæ­¥ï¼‰ï¼›**Vector**æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»

```java
package Thread;

import java.util.ArrayList;
import java.util.TreeSet;

public class ThreadSecurityClassTest {
    public static void main(String[] args) {
        //ArrayList<Integer> arrayList = new ArrayList<>(); ä¸å®‰å…¨
        Vector<Integer> arrayList = new Vector<>();//å®‰å…¨
        Thread threadA = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 1000; i++) {
                    arrayList.add(i);
                }
            }
        },"ThreadA");

        Thread threadB = new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 2000; i++) {
                    arrayList.add(i);
                }
            }
        },"ThreadB");

        threadA.start();
        threadB.start();

        try {
            threadA.join();
            threadB.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println(arrayList.size());
        System.out.println("ç»“æŸ");
    }
}
/*
Exception in thread "ThreadA" java.lang.ArrayIndexOutOfBoundsException: Index 16 out of bounds for length 15
	at java.base/java.util.ArrayList.add(ArrayList.java:455)
	at java.base/java.util.ArrayList.add(ArrayList.java:467)
	at Thread.ThreadSecurityClassTest$1.run(ThreadSecurityClassTest.java:14)
	at java.base/java.lang.Thread.run(Thread.java:833)
2009
ç»“æŸ

Process finished with exit code 0
*/
```

2ã€HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›**HashTable**æ˜¯çº¿ç¨‹å®‰å…¨çš„(ç»™æ¯ä¸ªæ–¹æ³•éƒ½åŠ äº†åŒæ­¥ï¼Œæ•ˆç‡ä½ï¼Œå·²è¢«æŠ›å¼ƒ)ï¼Œå¤šçº¿ç¨‹é«˜å¹¶å‘é¡¹ç›®å»ºè®®ä½¿ç”¨**ConcurrentHashMap**

3ã€**ConcurrentHashMap**çš„ä½¿ç”¨

ğŸ–ï¼šConcurrentHashMapsynchronizedå…³é”®å­—æ˜¯æ”¾åœ¨æ–¹æ³•ä½“å†…éƒ¨ï¼ˆåŒæ­¥ä»£ç å—ï¼‰ï¼Œä¸”æ²¡æœ‰é”æ•´ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸”getæ–¹æ³•æ²¡æœ‰åŠ é”ï¼ˆåªå–æ•°æ®ä¸ä¼šæœ‰æ•°æ®å®‰å…¨é—®é¢˜ï¼‰

ConcurrentHashMap - putæ–¹æ³•æºç 

```java
public V put(K key, V value) {
    return putVal(key, value, false);
}
```

**synchronized (f)** :åªé”æ¡¶ä½(f),è¿™é‡Œçš„æ¡¶ä½æŒ‡mapåº•å±‚å­˜æ”¾åœ¨Nodeæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå³æ‰©å……é“¾è¡¨çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼

<img src="D:\ç®—æ³•Typora\picture\image-20220713170212148.png" alt="image-20220713170212148" style="zoom:50%;" />

**HashMapï¼š**

â€‹	**HashMap**æ•´ä½“ä¸Šå¯ä»¥çœ‹ä½œæ˜¯**æ•°ç»„+é“¾è¡¨**çš„å½¢å¼ã€‚æ•°ç»„æ˜¯ä¸ºäº†è¿›è¡Œå¿«é€Ÿæ£€ç´¢ï¼Œè€Œå¦‚æœ**hashå‡½æ•°å†²çªäº†çš„è¯ï¼Œå°±ä¼šåœ¨åŒä¸€ä¸ªä½ç½®å¤„åé¢è¿›è¡ŒæŒ‚é“¾è¡¨çš„æ“ä½œ**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªé“¾è¡¨ä¸Šçš„èŠ‚ç‚¹ï¼Œå®ƒä»¬çš„hashå€¼è®¡ç®—å‡ºæ¥éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯å¦‚æœhashå†²çªæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œç”Ÿæˆçš„é“¾è¡¨ä¹Ÿä¼šæ‹‰å¾—æ¯”è¾ƒé•¿ï¼Œè¿™ä¸ªæ—¶å€™æ£€ç´¢èµ·æ¥å°±ä¼šé€€åŒ–æˆéå†æ“ä½œï¼Œæ€§èƒ½å°±æ¯”è¾ƒä½äº†ã€‚åœ¨Java 8ä¸­ä¸ºäº†æ”¹å–„è¿™ç§æƒ…å†µï¼Œå¼•å…¥äº†**çº¢é»‘æ ‘**ã€‚

â€‹	çº¢é»‘æ ‘æ˜¯ä¸€ç§é«˜çº§çš„å¹³è¡¡äºŒå‰æ ‘ç»“æ„ï¼Œå…¶èƒ½**ä¿è¯æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦æœ€åä¸ºO(logn)**ã€‚åœ¨å¤§æ•°æ®é‡çš„åœºæ™¯ä¸‹ï¼Œç›¸æ¯”äºAVLæ ‘ï¼Œçº¢é»‘æ ‘çš„æ’å…¥åˆ é™¤æ€§èƒ½è¦æ›´é«˜ã€‚å½“é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æ•°é‡å¤§äºç­‰äº8çš„æ—¶å€™ï¼Œ**åŒæ—¶å½“å‰æ•°ç»„ä¸­çš„é•¿åº¦å¤§äºç­‰äºMIN_TREEIFY_CAPACITYï¼ˆ64ï¼‰æ—¶**ï¼Œé“¾è¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¼šè¢«è½¬åŒ–æˆçº¢é»‘æ ‘ï¼Œè€Œå¦‚æœå½“å‰é“¾è¡¨èŠ‚ç‚¹çš„æ•°é‡å°äºç­‰äº6çš„æ—¶å€™ï¼Œçº¢é»‘æ ‘åˆä¼šè¢«é€€åŒ–æˆé“¾è¡¨ã€‚

â€‹	ä¹Ÿå°±æ˜¯è¯´**å½“å‰æ•°ç»„ä¸­çš„é•¿åº¦ï¼ˆä¹Ÿå°±æ˜¯æ¡¶binçš„ä¸ªæ•°ï¼‰å¿…é¡»å¤§äºç­‰äº64çš„æ—¶å€™ï¼ŒåŒæ—¶å½“å‰è¿™ä¸ªé“¾è¡¨çš„é•¿åº¦å¤§äºç­‰äº8çš„æ—¶å€™ï¼Œæ‰èƒ½è½¬åŒ–ã€‚**å¦‚æœå½“å‰æ•°ç»„ä¸­çš„é•¿åº¦å°äº64ï¼Œå³ä½¿å½“å‰é“¾è¡¨çš„é•¿åº¦å·²ç»å¤§äº8äº†ï¼Œä¹Ÿä¸ä¼šè½¬åŒ–ã€‚

â€‹	**é‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨çº¢é»‘æ ‘æ¥ä»£æ›¿é“¾è¡¨ï¼Œè€Œæ˜¯é‡‡ç”¨é“¾è¡¨å’Œçº¢é»‘æ ‘æ¥æ­é…åœ¨ä¸€èµ·ä½¿ç”¨å‘¢ï¼Ÿ**åŸå› å°±åœ¨äºçº¢é»‘æ ‘è™½ç„¶æ€§èƒ½æ›´å¥½ï¼Œä½†æ˜¯è¿™ä¹Ÿä»…æ˜¯åœ¨**å¤§æ•°æ®é‡**ä¸‹æ‰èƒ½çœ‹åˆ°å·®å¼‚ã€‚å¦‚æœå½“å‰æ•°æ®é‡å¾ˆå°ï¼Œå°±å‡ ä¸ªèŠ‚ç‚¹çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶æ˜¾ç„¶ç”¨é“¾è¡¨çš„æ–¹å¼ä¼šæ›´åˆ’ç®—ã€‚å› ä¸ºè¦çŸ¥é“**çº¢é»‘æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œä¼šæ¶‰åŠåˆ°å¤§é‡çš„è‡ªæ—‹**ï¼Œä»¥æ­¤æ¥ä¿è¯æ ‘ç»“æ„çš„å¹³è¡¡ã€‚å¦‚æœæ•°æ®é‡å°çš„è¯ï¼Œæ’å…¥åˆ é™¤çš„æ€§èƒ½é«˜æ•ˆæ ¹æœ¬æŠµæ¶ˆä¸äº†è‡ªæ—‹æ“ä½œæ‰€å¸¦æ¥çš„æˆæœ¬ã€‚

â€‹	**è¿˜æœ‰ä¸€ç‚¹éœ€è¦ç•™æ„çš„æ˜¯é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼æ˜¯8ï¼Œè€Œçº¢é»‘æ ‘é€€åŒ–æˆé“¾è¡¨çš„é˜ˆå€¼æ˜¯6ã€‚**ä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªå€¼ä¼šä¸ä¸€æ ·å‘¢ï¼Ÿå°†ä¸¤ä¸ªé˜ˆå€¼é”™å¼€ä¸€äº›ï¼Œä»¥æ­¤æ¥å°½é‡é¿å…åœ¨é˜ˆå€¼ç‚¹é™„è¿‘å¯èƒ½å­˜åœ¨çš„ã€é¢‘ç¹åœ°åšè½¬æ¢æ•°æ®ç»“æ„æ“ä½œè€Œå¯¼è‡´æ€§èƒ½å˜ä½çš„æƒ…å†µå‡ºç°ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é˜ˆå€¼ä¼šé€‰æ‹©ä¸º8æ˜¯é€šè¿‡æ•°å­¦ç»Ÿè®¡ä¸Šçš„ç»“è®ºå¾—å‡ºçš„ï¼Œåœ¨æºç ä¸­ä¹Ÿæœ‰ç›¸å…³æ³¨é‡Šã€‚

HashMapåº•å±‚æ•°æ®ç»“æ„ç¤ºæ„å›¾ï¼š

<img src="D:\ç®—æ³•Typora\picture\image-20220713192505446.png" alt="image-20220713192505446" style="zoom:50%;" />

```java
final V putVal(K key, V value, boolean onlyIfAbsent) {
    if (key == null || value == null) throw new NullPointerException();
    int hash = spread(key.hashCode());
    int binCount = 0;
    for (Node<K,V>[] tab = table;;) {
        Node<K,V> f; int n, i, fh; K fk; V fv;
        if (tab == null || (n = tab.length) == 0)
            tab = initTable();
        else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {
            if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value)))
                break;                   // no lock when adding to empty bin
        }
        else if ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);
        else if (onlyIfAbsent // check first node without acquiring lock
                 && fh == hash
                 && ((fk = f.key) == key || (fk != null && key.equals(fk)))
                 && (fv = f.val) != null)
            return fv;
        else {
            V oldVal = null;
            synchronized (f) {
                if (tabAt(tab, i) == f) {
                    if (fh >= 0) {
                        binCount = 1;
                        for (Node<K,V> e = f;; ++binCount) {
                            K ek;
                            if (e.hash == hash &&
                                ((ek = e.key) == key ||
                                 (ek != null && key.equals(ek)))) {
                                oldVal = e.val;
                                if (!onlyIfAbsent)
                                    e.val = value;
                                break;
                            }
                            Node<K,V> pred = e;
                            if ((e = e.next) == null) {
                                pred.next = new Node<K,V>(hash, key, value);
                                break;
                            }
                        }
                    }
                    else if (f instanceof TreeBin) {
                        Node<K,V> p;
                        binCount = 2;
                        if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,
                                                       value)) != null) {
                            oldVal = p.val;
                            if (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                    else if (f instanceof ReservationNode)
                        throw new IllegalStateException("Recursive update");
                }
            }
            if (binCount != 0) {
                if (binCount >= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                if (oldVal != null)
                    return oldVal;
                break;
            }
        }
    }
    addCount(1L, binCount);
    return null;
}
```

ctrl + alt + Mï¼šé€‰ä¸­ä»£ç ,å¿«é€Ÿå°è£…åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­

### 2ã€åŸå­æ€§ç±»ï¼ˆAtomicï¼‰ï¼šåŸç†æ˜¯åˆ©ç”¨æ— é”ç¼–ç¨‹CAS(compare and swap)

![image-20220717104910607](D:\ç®—æ³•Typora\picture\image-20220717104910607.png)

â€‹	çº¿ç¨‹æ“ä½œå®Œä»å…±äº«ä¸»å­˜ä¸­æ‹·è´çš„å€¼åï¼Œæ–°çš„å€¼æƒ³è¦åˆ·æ–°å›ä¸»å­˜ï¼Œéœ€è¦å…ˆ**æ¯”è¾ƒ**ï¼Œå³æ¯”è¾ƒä¸»å­˜ä¸­çš„å€¼ä¸çº¿ç¨‹ä¸€å¼€å§‹æ‹·è´çš„å€¼æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·åˆ™è¯´æ˜æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¹²æ‰°ï¼Œå¯æ”¾å¿ƒåœ°æŠŠå€¼åŒæ­¥åˆ·æ–°å›ä¸»å­˜ã€‚

â€‹	**ç¼ºç‚¹ï¼š1ã€è™½ç„¶çœå»äº†ä¸Šé”æ”¾é”ï¼Œä½†æºç ä¸­ä¾æ—§æœ‰do-whileå¾ªç¯** -> åœ¨çº¿ç¨‹å°‘ï¼ˆç«äº‰å°‘çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ï¼‰

â€‹		 **2ã€åŸå­æ€§èŒƒå›´æœ‰é™ï¼Œåªèƒ½åšåˆ°ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§ï¼›**	

2.1 AtomicIntegerï¼š

atomicInteger.get() -> è·å–å€¼

atomicInteger.incrementAndGet() -> è‡ªåŠ ;    decrementAndGet() -> è‡ªå‡

```java
private static AtomicInteger atomicInteger = new AtomicInteger(0);
public static void main(String[] args){

    Thread threadA = new Thread(new Runnable() {
        @Override
        public void run() {
            for (int i = 0; i < 20; i++) {
                atomicInteger.incrementAndGet();
            }
        }
    },"ThreadA");

    Thread threadB = new Thread(new Runnable() {
        @Override
        public void run() {
            for (int i = 0; i < 20; i++) {
                atomicInteger.incrementAndGet();
            }
        }
    },"ThreadB");
    threadA.start();
    threadB.start();
    try {
        threadA.join();
        threadB.join();
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    System.out.println(atomicInteger.get());

}
```

### 3ã€CASçš„ç¼ºç‚¹ï¼š

ğŸ“•ï¼š

- CASä¼šå¸¦æ¥**ABAçš„é—®é¢˜**ï¼šå‡è®¾çº¿ç¨‹Aè¯»åˆ°å½“å‰å€¼æ˜¯10ï¼Œå¯èƒ½çº¿ç¨‹BæŠŠå€¼ä¿®æ”¹ä¸º100ï¼Œç„¶åçº¿ç¨‹CåˆæŠŠå€¼ä¿®æ”¹ä¸º10ï¼›ç­‰åˆ°çº¿ç¨‹Aæ‹¿åˆ°æ‰§è¡Œæƒæ—¶ï¼Œå› ä¸ºå½“å‰å€¼å’Œå†…å­˜å€¼æ˜¯ä¸€è‡´çš„ï¼Œçº¿ç¨‹Aæ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼ç«™åœ¨çº¿ç¨‹Açš„è§’åº¦æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯ä»æœªè¢«ä¿®æ”¹çš„ï¼›è¿™æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä»ä¸Šå¸çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªå˜é‡å·²ç»è¢«çº¿ç¨‹Bå’Œçº¿ç¨‹Cä¿®æ”¹è¿‡äº†ã€‚æ¯”å¦‚æ¶‰åŠåˆ°é“¾è¡¨èŠ‚ç‚¹å¢åˆ çš„æ—¶å€™ï¼š

  ![img](D:\ç®—æ³•Typora\picture\008i3skNgy1gtt0jzngenj60qo0uc77s02.jpg)

  è¦è§£å†³ABAé—®é¢˜ï¼ŒJavaä¹Ÿæä¾›äº†AtomicStampedReferenceç±»ä¾›æˆ‘ä»¬ç”¨ï¼Œè¯´ç™½äº†å°±æ˜¯åŠ äº†ä¸ªç‰ˆæœ¬ï¼Œ**æ¯”å¯¹çš„å°±æ˜¯å†…å­˜å€¼+ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´**ï¼›

  ğŸ“•ï¼šä¸åŒæ¶æ„çš„CPUéƒ½æä¾›äº†æŒ‡ä»¤çº§åˆ«çš„CASåŸå­æ“ä½œï¼Œæ¯”å¦‚X86ç³»ç»Ÿä¸­ï¼Œé€šè¿‡`cmpxchg`æŒ‡ä»¤æ”¯æŒCASï¼Œä½¿å¾—CPUåŸç”Ÿæ”¯æŒCASï¼Œä¸éœ€è¦ç»è¿‡mutexç­‰æ“ä½œï¼›                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                

## å…­ã€çº¿ç¨‹é—´çš„é€šä¿¡

### 6.1 ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ ä½¿ç”¨åœºæ™¯ï¼šçº¿ç¨‹å¤„ç†ä»»åŠ¡é€Ÿåº¦ä¸åŒ¹é…

#### 6.1.1 ä½¿ç”¨synchronizedå®ç°

â€‹	**wait()æ–¹æ³•**(Objectç±»ä¸­çš„æ–¹æ³•) **notify()** **notifyAll()**

- å½“éœ€è¦è®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼ˆè¿›å…¥å¯¹è±¡çš„ç­‰å¾…æ± ï¼‰æ—¶ï¼Œè°ƒç”¨wait()ï¼›
- waitè°ƒç”¨å®Œåï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾å¯¹è±¡é”ï¼Œä¸”å½“å‰çº¿ç¨‹è¿›å…¥å½“å‰å¯¹è±¡çš„ç­‰å¾…æ± ï¼Œåªèƒ½è¢«å…¶ä»–çº¿ç¨‹å”¤é†’ï¼›
- çº¿ç¨‹è¿›å…¥ç­‰å¾…æ± ï¼Œæ˜¯ä¸ºäº†è¢«å”¤é†’å†æ¬¡é‡æ–°è·å–å¯¹è±¡é”ï¼›
- wait()æ–¹æ³•åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥ä»£ç å—ä¸­ï¼Œä¸”ä¸€èˆ¬è¦ç”¨åœ¨whileå¾ªç¯ä¸­
- å”¤é†’çº¿ç¨‹:**notify()ï¼šéšæœºå”¤é†’ä¸€ä¸ªå”¤é†’å½“å‰å¯¹è±¡ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹**ï¼›**notifyAll()ï¼šå”¤é†’å½“å‰å¯¹è±¡æ‰€æœ‰çº¿ç¨‹**ï¼Œä¹Ÿåªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥ä»£ç å—ä¸­

```java
package Thread.communication;

public class Store {
    private int count;
    private final int MAX = 100;//ä»“åº“æœ€å¤§å®¹é‡ -> å¯ä½¿ç”¨å†…å­˜

    /*
    put:ç”Ÿäº§å•†å“
     */
    public void put() {
        synchronized (this) {
            while (count == MAX) {
                System.out.println("ä»“åº“æ»¡äº†ï¼Œç”Ÿäº§è€…ç­‰å¾…");
                //éœ€è¦è®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¹¶ä¸”é‡Šæ”¾å¯¹è±¡é”
                try {
                    this.wait();//waitè°ƒç”¨å®Œåï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾å¯¹è±¡é”ï¼Œä¸”å½“å‰çº¿ç¨‹è¿›å…¥å½“å‰å¯¹è±¡çš„ç­‰å¾…æ± 
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            count++;
            System.out.println("ç”Ÿäº§äº†ä¸€ä»¶å•†å“");

            //å”¤é†’æ¶ˆè´¹è€…
            this.notifyAll();
        }
    }
    /*
    get:æ¶ˆè´¹å•†å“
     */
    public void get() {
        synchronized (this) {
            while (count == 0) {
                System.out.println("ä»“åº“ç©ºäº†ï¼Œæ¶ˆè´¹è€…ç­‰å¾…");
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
        count--;
        System.out.println("æ¶ˆè´¹äº†ä¸€ä»¶å•†å“");
        //éšæœºå”¤é†’æŸä¸ªå”¤é†’å½“å‰å¯¹è±¡ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹
        //this.notify();

        //å”¤é†’æ‰€æœ‰
        this.notifyAll();

    }

}
```

ç”Ÿäº§è€…æ¶ˆè´¹è€…æµ‹è¯•ï¼š

```java
package Thread.communication;

public class StoreTest {
    public static void main(String[] args) {

        Store store = new Store();
        //åä¸ªç”Ÿäº§è€…ï¼Œæ¯ä¸ªç”Ÿäº§è€…ç”Ÿäº§200æ¬¡ï¼›
        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                for (int j = 0; j < 200; j++) {
                    store.put();
                }
            }).start();
        }

        //åä¸ªæ¶ˆè´¹è€…,æ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹200æ¬¡ï¼›
        for (int i = 0; i < 10; i++) {
            new Thread(() ->{
                for (int j = 0; j < 200; j++) {
                    store.get();
                }
            }).start();
        }
    }
}
```

**é¢è¯•é¢˜ï¼šsleep() ä¸ wait()åŒºåˆ«ï¼š**

1. sleepæ˜¯Threadçš„é™æ€æ–¹æ³•ï¼Œwaitæ˜¯Objectçš„å®ä¾‹æ–¹æ³•ï¼›
2. sleepå¯ä»¥åœ¨ä»»æ„åœ°æ–¹è°ƒç”¨ï¼Œwaitåªèƒ½å‡ºç°åœ¨synchronizedä¿®é¥°çš„åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥ä»£ç å—ä¸­ï¼›
3. sleepä¸ä¼šé‡Šæ”¾é”ï¼ˆæŠ±ç€ğŸ”’ç¡ï¼‰ï¼Œwaitä¼šä½¿å¾—å½“å‰çº¿ç¨‹é‡Šæ”¾å¯¹è±¡é”ã€‚



#### 6.1.2 ä½¿ç”¨ReentrantLockå®ç°

- å€ŸåŠ©Conditionæ¥å£ï¼š**private Condition condition = lock.newCondition();**
- è®©çº¿ç¨‹ç­‰å¾…ï¼š**condition.await()**;å”¤é†’çº¿ç¨‹ï¼šcondition.signal()ã€**condition.signalAll()**ï¼›
- ä¸synchronizedä¸­çš„ä½¿ç”¨wait()ä¸€æ ·ï¼Œawait()ä¸signal()ä¹Ÿåªèƒ½åœ¨lockæ˜¾ç¤ºé”çš„åŒæ­¥å—ä¸­ï¼

```java
package Thread.communication;

import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;

public class Store2 {
    private int count;
    private final int MAX = 100;//ä»“åº“æœ€å¤§å®¹é‡ -> å¯ä½¿ç”¨å†…å­˜

    private ReentrantLock lock = new ReentrantLock();
    //æ¡ä»¶å¯¹è±¡
    private Condition condition = lock.newCondition();

    /*
    put:ç”Ÿäº§å•†å“
     */
    public void put() {
        lock.lock();
        try {
            while (count == MAX) {
                System.out.println("ä»“åº“æ»¡äº†ï¼Œç”Ÿäº§è€…ç­‰å¾…");
                //éœ€è¦è®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¹¶ä¸”é‡Šæ”¾å¯¹è±¡é”
                condition.await();
            }
            count++;
            System.out.println(Thread.currentThread().getName() + "ç”Ÿäº§äº†ä¸€ä»¶å•†å“,æ€»æ•°ä¸º" + count);
            //å”¤é†’æ¶ˆè´¹è€…-å”¤é†’ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹
            //condition.signal();
            condition.signalAll();

        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
    /*
    get:æ¶ˆè´¹å•†å“
     */
    public void get() {

        lock.lock();
        try {
            while (count == 0) {
                System.out.println("ä»“åº“ç©ºäº†ï¼Œæ¶ˆè´¹è€…ç­‰å¾…");
                condition.await();
            }
            count--;
            System.out.println(Thread.currentThread().getName() + "æ¶ˆè´¹äº†ä¸€ä»¶å•†å“,æ€»æ•°ä¸º" + count);
            //å”¤é†’æ¶ˆè´¹è€…-å”¤é†’ç­‰å¾…æ± ä¸­çš„çº¿ç¨‹
            //condition.signal();
            condition.signalAll();

        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}

```

## ä¸ƒã€å¤šçº¿ç¨‹ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

ğŸ“•ğŸ˜€

1. **åŸå­æ€§**ï¼šå¤šä¸ªæ“ä½œä¸å¯å†åˆ† ä¸èƒ½è¢«æ‰“æ–­ï¼›å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨è¢«å®Œæˆï¼Œè¦ä¹ˆä¸æ‰§è¡Œï¼›
   - synchronizedã€ReenentrantLockéƒ½å¯ä»¥åšåˆ°åŸå­æ€§ï¼›
   - åŸå­æ€§ç±»ï¼Œå¦‚AtomicIntegerï¼Œç¼ºç‚¹æ˜¯åªèƒ½ç»´æŠ¤ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§æ“ä½œ
2. **å¯è§æ€§**ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å†…å­˜çš„ä¿®æ”¹ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥çœ‹è§
   - synchronizedã€ReenentrantLockéƒ½å¯ä»¥åšåˆ°å¯è§æ€§ï¼›
   - volatileä¹Ÿå¯ä»¥åšåˆ°å¯è§æ€§ï¼›å…³é”®å­—volatileï¼šç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡ï¼Œä¿è¯æ­¤æˆå‘˜å˜é‡åœ¨å¤šçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œä¿è¯çº¿ç¨‹æ¯æ¬¡éƒ½å¿…é¡»ä»ä¸»å­˜è·å–æœ€æ–°å€¼ï¼ˆå¼ºåˆ¶ï¼‰ï¼›å¼ºåˆ¶çº¿ç¨‹å¯¹æˆå‘˜å˜é‡çš„æ”¹åŠ¨åè¦ç«‹åˆ»åˆ·æ–°å›ä¸»å­˜ï¼›ï¼ˆåšä¸åˆ°åŸå­æ€§ï¼‰
3. **æœ‰åºæ€§**ï¼š
   - æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå’Œç¼–ç é¡ºåºä¸ä¸€å®šä¸€è‡´ï¼›
   - JVMä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ–°æ’åºï¼Œä»¥æå‡æŒ‡ä»¤çš„æ‰§è¡Œæ€§èƒ½ï¼›
   - JVMä¿è¯åœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œç¨‹åºä¸ä¼šæœ‰ä»»åŠ¡é—®é¢˜ï¼Œä½†å¤šçº¿ç¨‹ä¸ä¿è¯ï¼›
   - volatileå¯ä»¥ç¦æ­¢JVMè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼›

ğŸ¦†ï¼š**double-checkï¼šä½¿ç”¨ volatile å…³é”®å­—æ¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å•ä¾‹ï¼š**

å…³äºdouble-checkï¼Œå‚è€ƒï¼š[Javaä¸­çš„åŒé‡æ£€æŸ¥é”ï¼ˆdouble checked lockingï¼‰ 

[- Decouple - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/xz816111/p/8470048.html)

```java
//å•ä¾‹
public class Singleton { 
  private volatile Singleton instance = null; //volatileç¦æ­¢JVMæŒ‡ä»¤é‡æ’ï¼Œä¿è¯ new Singleton()çš„3æ­¥æŒ‡ä»¤æœ‰åºæ‰§è¡Œ
  public Singleton getInstance() { 
    if (instance == null) { 
      synchronized(this) { 
        if (instance == null) { 
            //new åˆ†3æ­¥
            //1ã€åˆ†é…ç©ºé—´ï¼Œç»™å¯¹è±¡æ‰¾å†…å­˜
            //2ã€åˆ›å»ºå¯¹è±¡ï¼Œç»™æˆå‘˜å˜é‡èµ‹åˆå§‹å€¼
            //3ã€å¼•ç”¨èµ‹å€¼ 
            // JVMå¯èƒ½å¯¹è¿™ä¸‰æ­¥è¿›è¡Œé‡æ’
          instance = new Singleton(); 
        } 
      } 
    } 
    return instance; 
  } 
}
```



## å…«ã€å•ä¾‹æ¨¡å¼

- å•ä¾‹æ¨¡å¼æ˜¯ Java ä¸­æœ€ç®€å•çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒæ˜¯æŒ‡**ä¸€ä¸ªç±»åœ¨è¿è¡ŒæœŸé—´å§‹ç»ˆåªæœ‰ä¸€ä¸ªå®ä¾‹**ï¼Œæˆ‘ä»¬å°±æŠŠå®ƒç§°ä¹‹ä¸ºå•ä¾‹æ¨¡å¼ã€‚

- å•ä¾‹çš„å®ç°åˆ†ä¸º**é¥¿æ±‰æ¨¡å¼**å’Œ**æ‡’æ±‰æ¨¡å¼**

#### 8.1 é¥¿æ±‰æ¨¡å¼

- é¡¾åæ€ä¹‰ï¼Œé¥¿æ±‰æ¨¡å¼å°±å¥½æ¯”ä»–æ˜¯ä¸€ä¸ªé¥¿æ±‰ï¼Œè€Œä¸”æœ‰ä¸€å®šçš„å±æœºæ„è¯†ï¼Œä»–ä¼šæå‰æŠŠé£Ÿç‰©å›¤ç§¯å¥½ï¼Œä»¥å¤‡é¥¿äº†ä¹‹åç›´æ¥èƒ½åƒåˆ°é£Ÿç‰©ã€‚å¯¹åº”åˆ°ç¨‹åºä¸­æŒ‡çš„æ˜¯ï¼Œ**åœ¨ç±»åŠ è½½æ—¶å°±ä¼šè¿›è¡Œå•ä¾‹çš„åˆå§‹åŒ–**ï¼Œä»¥åè®¿é—®æ—¶ç›´æ¥ä½¿ç”¨å•ä¾‹å¯¹è±¡å³å¯ã€‚

```java
public class Singleton {
    // å£°æ˜ç§æœ‰å¯¹è±¡
    private static Singleton instance = new Singleton();    
    // è·å–å®ä¾‹ï¼ˆå•ä¾‹å¯¹è±¡ï¼‰
    public static Singleton getInstance() {
        return instance;
    }
    private Singleton() {
    }
    // æ–¹æ³•
    public void sayHi() {
        System.out.println("Hi,Java.");
    }
}
class SingletonTest {
    public static void main(String[] args) {
        // è°ƒç”¨å•ä¾‹å¯¹è±¡
        Singleton singleton = Singleton.getInstance();
        // è°ƒç”¨æ–¹æ³•
        singleton.sayHi();
    }
}
```

- **é¥¿æ±‰æ¨¡å¼ä¼˜ç‚¹ï¼š**
  - çº¿ç¨‹å®‰å…¨ï¼šå› ä¸ºå•ä¾‹å¯¹è±¡åœ¨ç±»åŠ è½½çš„æ—¶å€™å·²ç»è¢«åˆå§‹åŒ–äº†ï¼Œæ‰€ä»¥çº¿ç¨‹åœ¨è°ƒç”¨å•ä¾‹å¯¹è±¡æ—¶åªæ˜¯æŠŠå·²åˆ›å»ºå¥½çš„å¯¹è±¡èµ‹å€¼ç»™å˜é‡ï¼›

- **é¥¿æ±‰æ¨¡å¼ç¼ºç‚¹ï¼š**
  - å®¹æ˜“é€ æˆèµ„æºæµªè´¹ï¼šå¦‚æœç±»åŠ è½½äº†å¯¹è±¡ï¼ˆå¯¹è±¡è¢«åˆ›å»ºäº†ï¼‰ï¼Œä½†ä¸€ç›´æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œè¿™æ ·å°±é€ æˆäº†èµ„æºæµªè´¹ã€‚

#### 8.2 æ‡’æ±‰æ¨¡å¼

- é¡¾åæ€ä¹‰ä»–æ¯”è¾ƒæ‡’ï¼Œæ¯æ¬¡åªæœ‰éœ€è¦åƒé¥­çš„æ—¶å€™ï¼Œæ‰å‡ºå»æ‰¾é¥­åƒï¼Œè€Œä¸æ˜¯åƒé¥¿æ±‰é‚£æ ·æ—©æ—©æŠŠé¥­å‡†å¤‡å¥½ã€‚å¯¹åº”åˆ°ç¨‹åºä¸­æŒ‡çš„æ˜¯ï¼Œå½“**æ¯æ¬¡éœ€è¦ä½¿ç”¨å®ä¾‹æ—¶ï¼Œå†å»åˆ›å»ºè·å–å®ä¾‹ï¼Œè€Œä¸æ˜¯åœ¨ç±»åŠ è½½æ—¶å°±å°†å®ä¾‹åˆ›å»ºå¥½ã€‚**

```java
public class Singleton {
    // å£°æ˜ç§æœ‰å¯¹è±¡
    private static Singleton instance;
    // è·å–å®ä¾‹ï¼ˆå•ä¾‹å¯¹è±¡ï¼‰
    public static Singleton getInstance() {
        if (instance == null) {
            instance = new Singleton();
        }
        return instance;
    }
    private Singleton() {
    }
    // æ–¹æ³•
    public void sayHi() {
        System.out.println("Hi,Java.");
    }
}
class SingletonTest {
    public static void main(String[] args) {
        Singleton singleton = Singleton.getInstance();
        singleton.sayHi();
    }
}
```

- **æ‡’æ±‰æ¨¡å¼ä¼˜ç‚¹ï¼š**
  - ä¸ä¼šé€ æˆèµ„æºçš„æµªè´¹ï¼Œå› ä¸ºåœ¨è°ƒç”¨çš„æ—¶å€™æ‰ä¼šåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼›

- **æ‡’æ±‰æ¨¡å¼ç¼ºç‚¹ï¼š**

  - å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ—¶éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ°ifåˆ¤æ–­å¤„ï¼Œæ­¤æ—¶åˆ¤æ–­ç»“æœéƒ½æ˜¯æœªè¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹ä¼šåŒæ—¶åˆ›å»ºnä¸ªå®ä¾‹

  å¯é€šè¿‡**synchronized + åŒé‡é”æœºåˆ¶**å»æ”¹è¿›æ‡’æ±‰æ¨¡å¼ï¼

## ä¹ã€çº¿ç¨‹æ± 

- è§£å†³é¢‘ç¹åˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹çš„æ€§èƒ½æŸè€—
- æå‰å…ˆåˆ›å»ºå¥½ä¸€æ‰¹çº¿ç¨‹ï¼Œä»»åŠ¡åªéœ€è¦æäº¤ç»™çº¿ç¨‹ï¼Œthreadpoolä¼šä»æ± å­ä¸­æŒ‘é€‰çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼›æ‰§è¡Œä»»åŠ¡ç»“æŸä¹‹åç»§ç»­å›åˆ°æ± å­ä¸­ï¼Œæ¥ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼›
- å½“çº¿ç¨‹æ± é”€æ¯çš„æ—¶å€™ï¼Œæ‰å›å»ç»“æŸå…¶ä¸­çš„çº¿ç¨‹ï¼›
- èµ„æºé‡å¤åˆ©ç”¨ï¼Œå¯¹æ€§èƒ½çš„æå‡ï¼›

#### 1ã€åˆ›å»ºçº¿ç¨‹æ± æ–¹å¼ï¼š

- **çº¿ç¨‹ä¸ªæ•°å›ºå®šï¼š**`ExecutorService executorService = Executors.newFixedThreadPool(5);`****

- ##### **çº¿ç¨‹ä¸ªæ•°å¯ä¼¸ç¼©ï¼š**`Executors.newCachedThreadPool();`ğŸ–ï¼šæ± å­ä¸­60så†…æ²¡è¢«ä½¿ç”¨çš„çº¿ç¨‹ä¼šä»ç¼“å­˜ä¸­è¢«é”€æ¯ï¼›

- **å•ä¸ªçº¿ç¨‹ï¼š**`Executors.newSingleThreadExecutor()ï¼›`é€‚åˆç”¨æ¥åšä¸²è¡ŒåŒ–ä»»åŠ¡ï¼›

- **å®šæ—¶çº¿ç¨‹ï¼š**`Executors.newScheduledThreadPool(5);`

  - å»¶æ—¶ä»»åŠ¡ï¼ˆå»¶é•¿2sæ‰§è¡Œï¼‰ï¼š

    ```java
        ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(2);
                //å»¶æ—¶ä»»åŠ¡
        scheduledExecutorService.schedule(new Runnable() {
            @Override
            public void run() {
                System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œ");
            }
        },2,TimeUnit.SECONDS);
    ```

  - å®šæ—¶ä»»åŠ¡ï¼ˆå®šæœŸæ‰§è¡Œä»»åŠ¡ï¼‰ï¼š

    ```java
        scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
                System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œ");
            }
        },2,1,TimeUnit.SECONDS);
    ```

#### 2ã€å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡(**.submit()**)ï¼š

- `executorService.submit(Runnable Task)->æ— è¿”å›å€¼`

- `executorService.submit(Callable<T> Task)->æœ‰è¿”å›å€¼(Futureç±»)` 

  ```java
          Future<String> submit = executorService.submit(new Callable<String>() {
              @Override
              public String call() throws Exception {
                  return "";
              }
          });
  ```

- `executorService.execute(new Runnable() {})`(å¸¸ç”¨å‰ä¸¤ç§)

#### 3ã€åœæ­¢çº¿ç¨‹æ± ï¼š

`executorService.shutdown();`

**çº¿ç¨‹æ± ç¤ºä¾‹1ï¼š**

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ThreadPoolTest {
    public static void main(String[] args) {
        ExecutorService executorService = Executors.newFixedThreadPool(5);

        //
        for (int i = 0; i < 10; i++) {
            executorService.submit(() -> {
                System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œäº†");
            });
        }

        executorService.shutdown();
    }
}
/*
pool-1-thread-2æ‰§è¡Œäº†
pool-1-thread-5æ‰§è¡Œäº†
pool-1-thread-1æ‰§è¡Œäº†
pool-1-thread-4æ‰§è¡Œäº†
pool-1-thread-5æ‰§è¡Œäº†
pool-1-thread-1æ‰§è¡Œäº†
pool-1-thread-5æ‰§è¡Œäº†
pool-1-thread-4æ‰§è¡Œäº†
pool-1-thread-1æ‰§è¡Œäº†
pool-1-thread-3æ‰§è¡Œäº†
*/
```

#### 4ã€çº¿ç¨‹æ± çš„çœŸæ­£ä½¿ç”¨ï¼š

ğŸ–ğŸ–ğŸ–ï¼šä»¥ä¸Šå‡ ç§åˆ›å»ºçº¿ç¨‹æ± æ–¹å¼å…¶å®å¹¶ä¸ç”¨ï¼Œå› ä¸ºéƒ½æœ‰å„è‡ªçš„ç¼ºé™·ï¼

- `newFixedThreadPool`ï¼šæ²¡æœ‰éæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸”é˜»å¡é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯`LinkedBlockingQueue<>()`->é“¾è¡¨æ²¡æœ‰é•¿åº¦é™åˆ¶ï¼Œå¹¶å‘é‡é«˜æ—¶å®¹æ˜“å¯¼è‡´å†…å­˜æº¢å‡º(Out of Memory)ï¼
- `newCachedThreadPool`ï¼šæ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯intçš„æœ€å¤§å€¼0xfffffff(21äº¿)ï¼Œä¸”é˜»å¡é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯`SynchronousQueue<Runnable>()`ä¸å­˜å‚¨ä»»åŠ¡->ä¼šä¸€ç›´åˆ›å»ºçº¿ç¨‹ï¼Œç›´åˆ°ç”¨å®ŒCPUæœ€å¤§çš„çº¿ç¨‹æ•°ï¼Œä¼šæŠ¥é”™ï¼šunable to create new native thread

ğŸ§æ‰€ä»¥è¦è‡ªå·±é…ç½®çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ï¼

**çœŸæ­£ä½¿ç”¨çš„æ˜¯ï¼š**`new ThreadPoolExecutor(â€¦â€¦)`ï¼š

**çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ï¼š**

- `int corePoolSize`ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°

- `int maximumPoolSize`ï¼šæœ€å¤§çº¿ç¨‹ä¸ªæ•°

- `long keepAliveTime`ï¼šéæ ¸å¿ƒçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´

- `TimeUnit unit`ï¼šç©ºé—²æ—¶é—´å•ä½

- `BlockingQueue<Runnable> workQueue`ï¼š//å­˜æ”¾ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—

  â€‹	BlockingQueueå®ç°ç±»ï¼š

  â€‹		`new ArrayBlockingQueue<>(capacity)`

  â€‹		â€¦â€¦

```java
public ThreadPoolExecutor(int corePoolSize,//æ ¸å¿ƒçº¿ç¨‹æ•°
                          int maximumPoolSize,//æœ€å¤§çº¿ç¨‹ä¸ªæ•°
                          long keepAliveTime,//éæ ¸å¿ƒçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´
                          TimeUnit unit,//ç©ºé—²æ—¶é—´å•ä½
                          BlockingQueue<Runnable> workQueue) {//é˜»å¡é˜Ÿåˆ—
    this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
         Executors.defaultThreadFactory(), defaultHandler);
}
```

æ“ä½œæ­¥éª¤ï¼š

- å½“æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œå…ˆåˆ¤æ–­ç›®å‰æ ¸å¿ƒçº¿ç¨‹æ•°é‡æ˜¯å¦å·²ç»è¾¾åˆ°ï¼Œå¦‚æœçº¿ç¨‹æ•°é‡å·²ç»è¾¾åˆ°æ ¸å¿ƒæ•°é‡ï¼Œåˆ™æŠŠä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­;
- å¦‚æœæœªè¾¾åˆ°æ ¸å¿ƒæ•°é‡ï¼Œåˆ™åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡;
- å¦‚æœä»»åŠ¡é˜Ÿåˆ—å·²æ»¡è€Œæ­¤æ—¶å°šæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œåˆ™åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡;
- **å¦‚æœä»»åŠ¡é˜Ÿåˆ—å·²æ»¡è€Œä¸”çº¿ç¨‹æ•°é‡å·²è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œåˆ™ç›´æ¥æ‹’ç»ä»»åŠ¡**;

**ç¤ºä¾‹ï¼ˆThreadPoolExecutorï¼‰ï¼š**

```java
public static void main(String[] args) {

    ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(3,
                                                                   10,
                                                                   2,TimeUnit.SECONDS,
                                                                   new ArrayBlockingQueue<>(3));
    for (int i = 0; i < 14; i++) {//ä»»åŠ¡æ€»æ•°è¶…è¿‡æœ€å¤§çº¿ç¨‹ä¸ªæ•°ä¸é˜»å¡é˜Ÿåˆ—é•¿åº¦åï¼Œå¤šä½™çš„ä»»åŠ¡ä¼šè¢«æ‹’ç»
        threadPoolExecutor.submit(new Runnable() {
            @Override
            public void run() {
                System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œ");
                try {
                    TimeUnit.SECONDS.sleep(3L);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
    }
}
```



**é…ç½®çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°æ—¶çš„å…³æ³¨ç‚¹ï¼š**

1. ä»»åŠ¡åˆ†ä¸ºCPUå¯†é›†å‹ä»»åŠ¡ï¼ˆå¤§é‡çš„è®¡ç®—ï¼‰å’ŒIOå¯†é›†å‹ä»»åŠ¡ï¼ˆå¤§é‡çš„è¯»å†™ï¼‰ï¼›
2. CPUå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•°é‡ = CPUæ ¸æ•° + 1ï¼›
3. IOå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•°é‡ = CPUæ ¸æ•° * 2ï¼›



## åã€è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ€è·¯

è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ€è·¯æœ‰ä»¥ä¸‹ï¼š

- èƒ½ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè€ƒè™‘AtomicåŒ…ä¸‹çš„ç±»å¤Ÿä¸å¤Ÿæˆ‘ä»¬ä½¿ç”¨ã€‚
- èƒ½ä¸èƒ½ä¿è¯æ“ä½œçš„å¯è§æ€§ï¼Œè€ƒè™‘volatileå…³é”®å­—å¤Ÿä¸å¤Ÿæˆ‘ä»¬ä½¿ç”¨
- å¦‚æœæ¶‰åŠåˆ°å¯¹çº¿ç¨‹çš„æ§åˆ¶ï¼ˆæ¯”å¦‚ä¸€æ¬¡èƒ½ä½¿ç”¨å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹è§¦å‘çš„æ¡ä»¶æ˜¯å¦ä¾èµ–å…¶ä»–çº¿ç¨‹çš„ç»“æœï¼‰ï¼Œè€ƒè™‘CountDownLatch/Semaphoreç­‰ç­‰ã€‚
- å¦‚æœæ˜¯é›†åˆï¼Œè€ƒè™‘java.util.concurrentåŒ…ä¸‹çš„é›†åˆç±»ã€‚
- å¦‚æœsynchronizedæ— æ³•æ»¡è¶³ï¼Œè€ƒè™‘lockåŒ…ä¸‹çš„ç±»



## åä¸€ã€Threadlocal

![image-20220809102928288](D:\ç®—æ³•Typora\picture\image-20220809102928288.png)

### ä¸€ã€ç®€ä»‹

â€‹	ThreadLocalå«åš**çº¿ç¨‹å˜é‡**ï¼Œæ„æ€æ˜¯ThreadLocalä¸­**å¡«å……çš„å˜é‡**å±äº**å½“å‰çº¿ç¨‹**ï¼Œè¯¥å˜é‡å¯¹å…¶ä»–çº¿ç¨‹è€Œè¨€æ˜¯éš”ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å˜é‡æ˜¯å½“

å‰çº¿ç¨‹ç‹¬æœ‰çš„å˜é‡ã€‚`ThreadLocalä¸ºå˜é‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨çš„å‰¯æœ¬å˜é‡ã€‚`

ThreadLoal å˜é‡ï¼Œçº¿ç¨‹å±€éƒ¨å˜é‡ï¼ŒåŒä¸€ä¸ª ThreadLocal æ‰€åŒ…å«çš„å¯¹è±¡ï¼Œåœ¨ä¸åŒçš„ Thread ä¸­æœ‰ä¸åŒçš„å‰¯æœ¬ã€‚è¿™é‡Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

- å› ä¸ºæ¯ä¸ª Thread å†…æœ‰è‡ªå·±çš„å®ä¾‹å‰¯æœ¬ï¼Œä¸”**è¯¥å‰¯æœ¬åªèƒ½ç”±å½“å‰ Thread ä½¿ç”¨**ã€‚è¿™æ˜¯ä¹Ÿæ˜¯ ThreadLocal å‘½åçš„ç”±æ¥ã€‚
- æ—¢ç„¶æ¯ä¸ª Thread æœ‰è‡ªå·±çš„å®ä¾‹å‰¯æœ¬ï¼Œä¸”å…¶å®ƒ Thread ä¸å¯è®¿é—®ï¼Œé‚£å°±**ä¸å­˜åœ¨å¤šçº¿ç¨‹é—´å…±äº«çš„é—®é¢˜ã€‚**

â€‹	ThreadLocal æä¾›äº†çº¿ç¨‹æœ¬åœ°çš„å®ä¾‹ã€‚å®ƒä¸æ™®é€šå˜é‡çš„åŒºåˆ«åœ¨äºï¼Œæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„çº¿ç¨‹éƒ½ä¼šåˆå§‹åŒ–ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„å®ä¾‹å‰¯æœ¬ï¼›

ThreadLocal å˜é‡é€šå¸¸è¢«private staticä¿®é¥°ã€‚å½“ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ƒæ‰€ä½¿ç”¨çš„æ‰€æœ‰ ThreadLocal ç›¸å¯¹çš„å®ä¾‹å‰¯æœ¬éƒ½å¯è¢«å›æ”¶ã€‚

æ€»çš„æ¥è¯´ï¼Œ**ThreadLocal é€‚ç”¨äºæ¯ä¸ªçº¿ç¨‹éœ€è¦è‡ªå·±ç‹¬ç«‹çš„å®ä¾‹ä¸”è¯¥å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­è¢«ä½¿ç”¨ï¼Œä¹Ÿå³å˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»è€Œåœ¨æ–¹æ³•æˆ–ç±»é—´å…±äº«**

**çš„åœºæ™¯**

### äºŒã€ThreadLocalä¸Synchronizedçš„åŒºåˆ«

`ThreadLocal<T>`å…¶å®æ˜¯ä¸**çº¿ç¨‹ç»‘å®šçš„ä¸€ä¸ªå˜é‡**ã€‚ThreadLocalå’ŒSynchronizedéƒ½ç”¨äºè§£å†³å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ã€‚

ä½†æ˜¯ThreadLocalä¸synchronizedæœ‰æœ¬è´¨çš„åŒºåˆ«ï¼š

â€‹	1ã€**Synchronizedç”¨äºçº¿ç¨‹é—´çš„`æ•°æ®å…±äº«`ï¼Œè€ŒThreadLocalåˆ™ç”¨äºçº¿ç¨‹é—´çš„`æ•°æ®éš”ç¦»`ã€‚**

â€‹	2ã€Synchronizedæ˜¯åˆ©ç”¨é”çš„æœºåˆ¶ï¼Œä½¿å˜é‡æˆ–ä»£ç å—åœ¨æŸä¸€æ—¶è¯¥åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚è€ŒThreadLocalä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æä¾›äº†å˜é‡çš„å‰¯

æœ¬ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶é—´è®¿é—®åˆ°çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·å°±éš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„æ•°æ®å…±äº«ã€‚è€ŒSynchronizedå´æ­£å¥½ç›¸åï¼Œå®ƒç”¨äºåœ¨

å¤šä¸ªçº¿ç¨‹é—´é€šä¿¡æ—¶èƒ½å¤Ÿè·å¾—æ•°æ®å…±äº«ã€‚

â€‹	ä¸€å¥è¯ç†è§£ThreadLocalï¼ŒThreadLocalæ˜¯ä½œä¸ºå½“å‰**çº¿ç¨‹ä¸­å±æ€§**->`ThreadLocalMapé›†åˆ`ä¸­çš„æŸä¸€ä¸ªEntryçš„keyå€¼Entry

ï¼ˆthreadLocal,valueï¼‰ï¼Œè™½ç„¶ä¸åŒçš„çº¿ç¨‹ä¹‹é—´threadLocalè¿™ä¸ªkeyå€¼æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯ä¸åŒçš„çº¿ç¨‹æ‰€æ‹¥æœ‰çš„ThreadLocalMapæ˜¯ç‹¬ä¸€æ— äºŒ

çš„ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„çº¿ç¨‹é—´åŒä¸€ä¸ªThreadLocalï¼ˆkeyï¼‰å¯¹åº”å­˜å‚¨çš„å€¼(value)ä¸ä¸€æ ·ï¼Œä»è€Œåˆ°è¾¾äº†çº¿ç¨‹é—´å˜é‡éš”ç¦»çš„ç›®çš„ï¼Œä½†æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹

ä¸­è¿™ä¸ª**valueå˜é‡åœ°å€**æ˜¯ä¸€æ ·çš„ã€‚

### ä¸‰ã€ThreadLocalçš„ç®€å•ä½¿ç”¨

```java
public class ThreadLocaDemo {
 
    private static ThreadLocal<String> localVar = new ThreadLocal<String>();
 
    static void print(String str) {
        //æ‰“å°å½“å‰çº¿ç¨‹ä¸­æœ¬åœ°å†…å­˜ä¸­æœ¬åœ°å˜é‡çš„å€¼
        System.out.println(str + " :" + localVar.get());
        //æ¸…é™¤æœ¬åœ°å†…å­˜ä¸­çš„æœ¬åœ°å˜é‡
        localVar.remove();
    }
    public static void main(String[] args) throws InterruptedException {
 
        new Thread(new Runnable() {
            public void run() {
                ThreadLocaDemo.localVar.set("local_A");
                print("A");
                //æ‰“å°æœ¬åœ°å˜é‡
                System.out.println("after remove : " + localVar.get());
               
            }
        },"A").start();
 
        Thread.sleep(1000);
 
        new Thread(new Runnable() {
            public void run() {
                ThreadLocaDemo.localVar.set("local_B");
                print("B");
                System.out.println("after remove : " + localVar.get());
              
            }
        },"B").start();
    }
}
 
A :local_A
after remove : null
B :local_B
after remove : null
 
```

### å››ã€ThreadLocalçš„åŸç†

####   4.1 ThreadLocalçš„setæ–¹æ³•ï¼š

```java
 public void set(T value) {
        //1ã€è·å–å½“å‰çº¿ç¨‹
        Thread t = Thread.currentThread();
        //2ã€è·å–çº¿ç¨‹ä¸­çš„å±æ€§ threadLocalMap ,å¦‚æœthreadLocalMap ä¸ä¸ºç©ºï¼Œ
        //åˆ™ç›´æ¥æ›´æ–°è¦ä¿å­˜çš„å˜é‡å€¼ï¼Œå¦åˆ™åˆ›å»ºthreadLocalMapï¼Œå¹¶èµ‹å€¼
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            // åˆå§‹åŒ–thradLocalMap å¹¶èµ‹å€¼
            createMap(t, value);
    }
```

â€‹	`ThreadLocalMap`æ˜¯**ThreadLocalçš„å†…éƒ¨é™æ€ç±»**ï¼Œè€Œå®ƒçš„æ„æˆä¸»è¦æ˜¯ç”¨Entryæ¥ä¿å­˜æ•°æ® ï¼Œè€Œä¸”è¿˜æ˜¯**ç»§æ‰¿çš„å¼±å¼•ç”¨**ã€‚åœ¨Entryå†…éƒ¨ä½¿ç”¨ThreadLocalä½œä¸ºkeyï¼Œä½¿ç”¨æˆ‘ä»¬è®¾ç½®çš„valueä½œä¸ºvalueã€‚

```java
  static class ThreadLocalMap {
 
        /**
         * The entries in this hash map extend WeakReference, using
         * its main ref field as the key (which is always a
         * ThreadLocal object).  Note that null keys (i.e. entry.get()
         * == null) mean that the key is no longer referenced, so the
         * entry can be expunged from table.  Such entries are referred to
         * as "stale entries" in the code that follows.
         */
        static class Entry extends WeakReference<ThreadLocal<?>> {
            /** The value associated with this ThreadLocal. */
            Object value;
 
            Entry(ThreadLocal<?> k, Object v) {
                super(k);
                value = v;
            }
        }
 
        
    }
```

â€‹	createMap:

```java
//è¿™ä¸ªæ˜¯threadlocal çš„å†…éƒ¨æ–¹æ³•
void createMap(Thread t, T firstValue) {
        t.threadLocals = new ThreadLocalMap(this, firstValue);
    }
 
 
    //ThreadLocalMap æ„é€ æ–¹æ³•
ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
            table = new Entry[INITIAL_CAPACITY];
            int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);
            table[i] = new Entry(firstKey, firstValue);
            size = 1;
            setThreshold(INITIAL_CAPACITY);
        }
```

####  4.2 ThreadLocalçš„getæ–¹æ³•

```java
    public T get() {
        //1ã€è·å–å½“å‰çº¿ç¨‹
        Thread t = Thread.currentThread();
        //2ã€è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
        ThreadLocalMap map = getMap(t);
        //3ã€å¦‚æœmapæ•°æ®ä¸ºç©ºï¼Œ
        if (map != null) {
            //3.1ã€è·å–threalLocalMapä¸­å­˜å‚¨çš„å€¼
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        //å¦‚æœæ˜¯æ•°æ®ä¸ºnullï¼Œåˆ™åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–çš„ç»“æœï¼ŒTheralLocalMapä¸­å­˜æ”¾keyå€¼ä¸ºthreadLocalï¼Œå€¼ä¸ºnull
        return setInitialValue();
    }
 
 
private T setInitialValue() {
        T value = initialValue();
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            createMap(t, value);
        return value;
    }
```

#### 4.3 ThreadLocalçš„removeæ–¹æ³•

```java
 public void remove() {
         ThreadLocalMap m = getMap(Thread.currentThread());
         if (m != null)
             m.remove(this);
     }
```

â€‹	ä¸ºä»€ä¹ˆè¦åˆ é™¤ï¼Œè¿™æ¶‰åŠåˆ°**å†…å­˜æ³„éœ²**çš„é—®é¢˜

â€‹	ğŸ“•ï¼šå®é™…ä¸Š ThreadLocalMap ä¸­ä½¿ç”¨çš„ **key ä¸º ThreadLocal çš„å¼±å¼•ç”¨**ï¼Œå¼±å¼•ç”¨çš„ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡åªå­˜åœ¨å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶çš„æ—¶å€™å¿…ç„¶ä¼šè¢«æ¸…ç†æ‰ã€‚

â€‹	æ‰€ä»¥å¦‚æœ ThreadLocal æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ä¼šè¢«æ¸…ç†æ‰çš„ï¼Œè¿™æ ·ä¸€æ¥ ThreadLocalMapä¸­ä½¿ç”¨è¿™ä¸ª ThreadLocal çš„ key ä¹Ÿä¼šè¢«æ¸…ç†æ‰ã€‚ä½†æ˜¯ï¼Œ**value æ˜¯å¼ºå¼•ç”¨**ï¼Œä¸ä¼šè¢«æ¸…ç†ï¼Œè¿™æ ·ä¸€æ¥å°±**`ä¼šå‡ºç° key ä¸º null çš„ value`**ã€‚

â€‹	ThreadLocalå…¶å®æ˜¯ä¸çº¿ç¨‹ç»‘å®šçš„ä¸€ä¸ªå˜é‡ï¼Œå¦‚æ­¤å°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæ²¡æœ‰å°†ThreadLocalå†…çš„å˜é‡åˆ é™¤ï¼ˆremoveï¼‰æˆ–æ›¿æ¢ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå°†ä¼šä¸çº¿ç¨‹å…±å­˜ã€‚é€šå¸¸çº¿ç¨‹æ± ä¸­å¯¹çº¿ç¨‹ç®¡ç†éƒ½æ˜¯é‡‡ç”¨çº¿ç¨‹å¤ç”¨çš„æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¾ˆéš¾ç»“æŸç”šè‡³äºæ°¸è¿œä¸ä¼šç»“æŸï¼Œè¿™å°†æ„å‘³ç€çº¿ç¨‹æŒç»­çš„æ—¶é—´å°†ä¸å¯é¢„æµ‹ï¼Œç”šè‡³ä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ**å¦‚æœThreadLocalä¸­ç›´æ¥æˆ–é—´æ¥åŒ…è£…äº†é›†åˆç±»æˆ–å¤æ‚å¯¹è±¡ï¼Œæ¯æ¬¡åœ¨åŒä¸€ä¸ªThreadLocalä¸­å–å‡ºå¯¹è±¡åï¼Œå†å¯¹å†…å®¹åšæ“ä½œï¼Œé‚£ä¹ˆå†…éƒ¨çš„é›†åˆç±»å’Œå¤æ‚å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´å¯èƒ½ä¼šå¼€å§‹æŒç»­è†¨èƒ€ã€‚**

#### 4.4ã€ThreadLocalä¸Threadï¼ŒThreadLocalMapä¹‹é—´çš„å…³ç³»

<img src="D:\ç®—æ³•Typora\picture\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTA0NDUzMDE=,size_16,color_FFFFFF,t_70.png" alt="img" style="zoom:67%;" />

1. æ¯ä¸ªThreadçº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªMap (ThreadLocalMap)
2. Mapé‡Œé¢å­˜å‚¨ThreadLocalå¯¹è±¡(key)å’Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬(value)
3. Threadå†…éƒ¨çš„Mapæ˜¯ç”±ThreadLocalç»´æŠ¤çš„ï¼Œç”±ThreadLocalè´Ÿè´£å‘mapè·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼ã€‚
4. å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆäº†å‰¯æœ¬çš„éš”ç¦»,äº’ä¸å¹²æ‰°ã€‚

ğŸ§ä»è¿™ä¸ªå›¾ä¸­æˆ‘ä»¬å¯ä»¥éå¸¸ç›´è§‚çš„çœ‹å‡ºï¼Œ**ThreadLocalMapå…¶å®æ˜¯Threadçº¿ç¨‹çš„ä¸€ä¸ªå±æ€§å€¼**ï¼Œè€Œ**ThreadLocalæ˜¯ç»´æŠ¤ThreadLocalMap**

**è¿™ä¸ªå±æ€§æŒ‡çš„ä¸€ä¸ªå·¥å…·ç±»**ã€‚**Threadçº¿ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªThreadLocalç»´æŠ¤çš„è‡ªå·±çº¿ç¨‹ç‹¬äº«çš„å…±äº«å˜é‡**ï¼ˆè¿™ä¸ªå…±äº«å˜é‡åªæ˜¯é’ˆå¯¹è‡ªå·±çº¿ç¨‹é‡Œé¢å…±äº«ï¼‰

### äº”ã€ThreadLocal å¸¸è§ä½¿ç”¨åœºæ™¯

1. æ¯ä¸ªçº¿ç¨‹éœ€è¦æœ‰è‡ªå·±å•ç‹¬çš„å®ä¾‹
2. å®ä¾‹**éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­å…±äº«**ï¼Œä½†ä¸å¸Œæœ›è¢«å¤šçº¿ç¨‹å…±äº«

**åœºæ™¯ä¸€ã€å­˜å‚¨ç”¨æˆ·Session**

```java
private static final ThreadLocal threadSession = new ThreadLocal();
 
    public static Session getSession() throws InfrastructureException {
        Session s = (Session) threadSession.get();
        try {
            if (s == null) {
                s = getSessionFactory().openSession();
                threadSession.set(s);
            }
        } catch (HibernateException ex) {
            throw new InfrastructureException(ex);
        }
        return s;
    }
```

**åœºæ™¯äºŒã€æ•°æ®åº“è¿æ¥ï¼Œå¤„ç†æ•°æ®åº“äº‹åŠ¡**

**åœºæ™¯ä¸‰ã€æ•°æ®è·¨å±‚ä¼ é€’ï¼ˆcontroller,service, daoï¼‰**

 	æ¯ä¸ªçº¿ç¨‹å†…éœ€è¦ä¿å­˜ç±»ä¼¼äºå…¨å±€å˜é‡çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚åœ¨æ‹¦æˆªå™¨ä¸­è·å–çš„ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œå¯ä»¥è®©ä¸åŒæ–¹æ³•ç›´æ¥ä½¿ç”¨ï¼Œé¿å…å‚æ•°ä¼ é€’çš„éº»çƒ¦å´ä¸æƒ³è¢«å¤šçº¿ç¨‹å…±äº«ï¼ˆå› ä¸ºä¸åŒçº¿ç¨‹è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯ä¸ä¸€æ ·ï¼‰ã€‚

â€‹	ä¾‹å¦‚ï¼Œç”¨ ThreadLocal ä¿å­˜ä¸€äº›ä¸šåŠ¡å†…å®¹ï¼ˆç”¨æˆ·æƒé™ä¿¡æ¯ã€ä»ç”¨æˆ·ç³»ç»Ÿè·å–åˆ°çš„ç”¨æˆ·åã€ç”¨æˆ·ID ç­‰ï¼‰ï¼Œè¿™äº›ä¿¡æ¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ç›¸åŒï¼Œä½†æ˜¯ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨çš„ä¸šåŠ¡å†…å®¹æ˜¯ä¸ç›¸åŒçš„ã€‚

â€‹	åœ¨çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå†…ï¼Œéƒ½é€šè¿‡è¿™ä¸ªé™æ€ ThreadLocal å®ä¾‹çš„ get() æ–¹æ³•å–å¾—è‡ªå·± set è¿‡çš„é‚£ä¸ªå¯¹è±¡ï¼Œé¿å…äº†å°†è¿™ä¸ªå¯¹è±¡ï¼ˆå¦‚ user å¯¹è±¡ï¼‰ä½œä¸ºå‚æ•°ä¼ é€’çš„éº»çƒ¦ã€‚

â€‹	æ¯”å¦‚è¯´æˆ‘ä»¬æ˜¯ä¸€ä¸ªç”¨æˆ·ç³»ç»Ÿï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹ä¼šè´Ÿè´£æ‰§è¡Œè¿™ä¸ªè¯·æ±‚ï¼Œç„¶åè¿™ä¸ªè¯·æ±‚å°±ä¼šä¾æ¬¡è°ƒç”¨service-1()ã€service-2()ã€service-3()ã€service-4()ï¼Œè¿™4ä¸ªæ–¹æ³•å¯èƒ½æ˜¯åˆ†å¸ƒåœ¨ä¸åŒçš„ç±»ä¸­çš„ã€‚è¿™ä¸ªä¾‹å­å’Œå­˜å‚¨sessionæœ‰äº›åƒã€‚
**åœºæ™¯å››ã€Springä½¿ç”¨ThreadLocalè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜** 

### å…­ã€å†…å­˜æ³„æ¼é—®é¢˜

 	Entryå°†ThreadLocalä½œä¸ºKeyï¼Œå€¼ä½œä¸ºvalueä¿å­˜ï¼Œå®ƒç»§æ‰¿è‡ª`WeakReference`ï¼Œæ³¨æ„æ„é€ å‡½æ•°é‡Œçš„ç¬¬ä¸€è¡Œä»£ç super(k)ï¼Œè¿™æ„å‘³ç€**ThreadLocalå¯¹è±¡æ˜¯ä¸€ä¸ªã€Œå¼±å¼•ç”¨ã€**

ä¸»è¦ä¸¤ä¸ªåŸå› 
1 . æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry
2 . CurrentThread å½“å‰çº¿ç¨‹ä¾ç„¶è¿è¡Œ

 ç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œåªè¦åœ¨ä½¿ç”¨å®Œä¸‹ ThreadLocal ï¼Œè°ƒç”¨å…¶ remove æ–¹æ³•åˆ é™¤å¯¹åº”çš„ Entry ï¼Œå°±èƒ½é¿å…å†…å­˜æ³„æ¼ã€‚

 ç¬¬äºŒç‚¹ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œç”±äºThreadLocalMap æ˜¯ Thread çš„ä¸€ä¸ªå±æ€§ï¼Œè¢«å½“å‰çº¿ç¨‹æ‰€å¼•ç”¨ï¼Œæ‰€ä»¥ThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿ã€‚**å¦‚æœthreadlocalå˜é‡è¢«å›æ”¶ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹çš„threadlocal å˜é‡å‰¯æœ¬æŒ‡å‘çš„å°±æ˜¯key=null**, ä¹Ÿå³**entry(null,value)**,é‚£è¿™**ä¸ªentryå¯¹åº”çš„valueæ°¸è¿œæ— æ³•è®¿é—®åˆ°**ã€‚å®é™…ç§ç”¨ThreadLocalåœºæ™¯éƒ½æ˜¯é‡‡ç”¨**çº¿ç¨‹æ± **ï¼Œè€Œçº¿ç¨‹æ± ä¸­çš„**çº¿ç¨‹éƒ½æ˜¯å¤ç”¨**çš„ï¼Œè¿™æ ·å°±å¯èƒ½**å¯¼è‡´éå¸¸å¤šçš„entry(null,value)å‡ºç°ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚**


â“ï¼šä¸ºä»€ä¹ˆä¸å°†keyè®¾ç½®ä¸ºå¼ºå¼•ç”¨ï¼Ÿ

â€‹	å¦‚æœkeyè®¾è®¡æˆå¼ºå¼•ç”¨ä¸”æ²¡æœ‰æ‰‹åŠ¨remove()ï¼Œé‚£ä¹ˆkeyä¼šå’Œvalueä¸€æ ·ä¼´éšçº¿ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚

â€‹    å‡è®¾åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨å®ŒThreadLocal, ThreadLocal refè¢«å›æ”¶äº†ï¼Œä½†æ˜¯å› ä¸ºthreadLocalMapçš„Entry**å¼ºå¼•ç”¨**äº†threadLocal(keyå°±æ˜¯threadLocal), **é€ æˆThreadLocalæ— æ³•è¢«å›æ”¶**ã€‚åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤Entryä»¥åŠCurrentThread(å½“å‰çº¿ç¨‹)ä¾ç„¶è¿è¡Œçš„å‰æä¸‹, **å§‹ç»ˆæœ‰å¼ºå¼•ç”¨é“¾**CurrentThread Ref â†’ CurrentThread â†’Map(ThreadLocalMap)-> entry, Entryå°±ä¸ä¼šè¢«å›æ”¶( Entryä¸­åŒ…æ‹¬äº†ThreadLocalå®ä¾‹å’Œvalue), å¯¼è‡´Entryå†…å­˜æ³„æ¼ï¼›ä¹Ÿå°±æ˜¯è¯´: **ThreadLocalMapä¸­çš„keyä½¿ç”¨äº†å¼ºå¼•ç”¨, æ˜¯æ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼çš„ã€‚**


â“ï¼šé‚£ä¹ˆä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨å‘¢ï¼Ÿ

â€‹	äº‹å®ä¸Šï¼Œåœ¨ ThreadLocalMap ä¸­çš„set/getEntry æ–¹æ³•ä¸­ï¼Œä¼šå¯¹ key ä¸º nullï¼ˆä¹Ÿå³æ˜¯ ThreadLocal ä¸º null ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸º null çš„è¯ï¼Œé‚£ä¹ˆä¼šæŠŠ value ç½®ä¸º null çš„ï¼è¿™å°±æ„å‘³ç€ä½¿ç”¨threadLocal , CurrentThread ä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œ**å°±ç®—å¿˜è®°è°ƒç”¨ remove æ–¹æ³•ï¼Œå¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœï¼šå¼±å¼•ç”¨çš„ ThreadLocal ä¼šè¢«å›æ”¶,**å¯¹åº”valueåœ¨ä¸‹ä¸€æ¬¡ ThreadLocal è°ƒç”¨ get()/set()/remove() ä¸­çš„ä»»ä¸€æ–¹æ³•çš„æ—¶å€™ä¼šè¢«æ¸…é™¤ï¼Œä»è€Œé¿å…å†…å­˜æ³„æ¼.

ğŸ“•ï¼šThreadLocal#setæ–¹æ³•æœ€ç»ˆè°ƒç”¨ThreadLocalMap#setæ–¹æ³•ï¼Œå¦‚æœkey==null, ä¼šè°ƒç”¨`replaceStaleEntry`è¿™ä¸ªæ–¹æ³•ï¼Œé‡Œé¢æœ‰æ®µä»£ç 
```java
// If key not found, put new entry in stale slot
tab[staleSlot].value = null;
```



â“ï¼šå¦‚ä½•æ­£ç¡®ä½¿ç”¨ThreadLocalï¼Ÿ

 1ã€**å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate static**çš„ï¼Œè¿™æ ·çš„è¯ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸå°±æ›´é•¿ï¼Œç”±äºä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥ThreadLocalä¹Ÿå°±ä¸ä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½æ ¹æ®ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œç„¶åremoveå®ƒï¼Œé˜²æ­¢å†…å­˜æ³„éœ²

 2ã€æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalï¼Œéƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚

**è¡¥å……ï¼š**ä¸ºäº†è§£å†³å› ä½¿ç”¨ä¸å½“å¯èƒ½å­˜åœ¨çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼ŒDoug Leaå¤§å¸ˆè¿˜æ˜¯åšäº†ä¸€äº›æ”¹è¿›æ¥å°½å¯èƒ½çš„é¿å…å‡ºç°å†…å­˜æ³„éœ²ï¼Œå°±æ˜¯æ–¹æ³•`cleanSomeSlotsã€expungeStaleEntryã€replaceStaleEntry`

ä»æºç æ·±å…¥è¯¦è§£ThreadLocalå†…å­˜æ³„æ¼é—®é¢˜ï¼šhttps://www.jianshu.com/p/dde92ec37bd1
